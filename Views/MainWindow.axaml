<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Retromind.ViewModels"
        xmlns:views="using:Retromind.Views"
        xmlns:models="using:Retromind.Models"
        xmlns:helpers="clr-namespace:Retromind.Helpers"
        xmlns:input="using:Avalonia.Input"
        xmlns:ext="clr-namespace:Retromind.Extensions;assembly=Retromind"

        xmlns:p="clr-namespace:Retromind.Resources"

        x:Class="Retromind.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        WindowState="Maximized"
        x:Name="MainWin"
        Title="{x:Static p:Strings.App_Title}"
        
        SystemDecorations="None" 
        Background="{Binding WindowBackground}"
        ExtendClientAreaToDecorationsHint="False"
        ExtendClientAreaTitleBarHeightHint="-1"
        
        TextInput="OnTextInput" >

    <Window.Resources>
        <!-- Vector icons to avoid emoji font fallback changes -->
        <Geometry x:Key="IconThemeToggle">
            M12 2A10 10 0 1 0 22 12A8 8 0 0 1 12 2Z
        </Geometry>
        <Geometry x:Key="IconSearch">
            M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 14 15.5l.27.28v.79L20 21.5 21.5 20 15.5 14z M10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z
        </Geometry>
        <Geometry x:Key="IconTv">
            M3 5h18v12H3z M5 19h14v2H5z
        </Geometry>
        <Geometry x:Key="IconSettings">
            M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.03 7.03 0 0 0-1.63-.94l-.36-2.54a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.54c-.58.24-1.12.55-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 8.84a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32a.5.5 0 0 0 .6.22l2.39-.96c.5.39 1.05.7 1.63.94l.36 2.54a.5.5 0 0 0 .5.42h3.84a.5.5 0 0 0 .5-.42l.36-2.54c.58-.24 1.12-.55 1.63-.94l2.39.96a.5.5 0 0 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58z M12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z
        </Geometry>
    </Window.Resources>

    <Window.DataTemplates>
        <DataTemplate DataType="{x:Type vm:MediaAreaViewModel}">
            <views:MediaAreaView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:SearchAreaViewModel}">
            <views:SearchAreaView />
        </DataTemplate>
    </Window.DataTemplates>

    <!-- We use a panel as the root to enable layering -->
    <Panel>
       <!-- LAYER -1: Global Fallback Background -->
       <Border Background="{Binding WindowBackground}" />

       <!-- LAYER 0: Wallpaper (lies over it) -->
       <ext:CrossfadeImage x:CompileBindings="False"
              Url="{Binding ResolvedSelectedItemWallpaperPath}"
              DecodeWidth="1920"
              DisableCache="True"
              Stretch="UniformToFill"
              FadeDurationMs="1600"
              Opacity="0.4"
              IsHitTestVisible="False"
              IsVisible="{Binding ResolvedSelectedItemWallpaperPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
       
       <!-- LAYER 1: The UI Grid (with semi-transparent backgrounds) -->
       <Grid RowDefinitions="30, *"> <!-- New line for custom title bar -->
       
           <!-- CUSTOM TITLEBAR (line 0) -->
           <Grid Grid.Row="0" Background="{Binding WindowBackground}" PointerPressed="OnTitleBarPointerPressed"
                 ColumnDefinitions="*, Auto">
               
               <!-- Title -->
               <TextBlock Grid.Column="0" Text="{Binding Title, ElementName=MainWin}" 
                          VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5" 
                          IsHitTestVisible="False"/> <!-- Important: HitTestFalse for drag to work -->
               
               <!-- Buttons StackPanel -->
               <StackPanel Grid.Column="1" Orientation="Horizontal">
                   
                   <!-- Minimize -->
                   <Button Content="_" Width="30" Height="30" Background="Transparent" BorderThickness="0"
                           Command="{Binding MinimizeWindow, ElementName=MainWin}" />

                   <!-- Maximize/Restore -->
                   <Button Content="□" Width="30" Height="30" Background="Transparent" BorderThickness="0"
                           Command="{Binding ToggleWindowState, ElementName=MainWin}" />

                   <!-- Close -->
                   <Button Content="✕" Width="30" Height="30" Background="Transparent" BorderThickness="0"
                           Command="{Binding CloseWindow, ElementName=MainWin}" 
                           Foreground="{Binding TextColor}" FontWeight="Bold"/> <!-- TextColor statt Rot -->
               </StackPanel>
           </Grid>

           <!-- REST OF THE APP (Line 1) -->
           <Grid Grid.Row="1">
               <!-- LAYER 1: The UI Grid (with semi-transparent backgrounds) -->
               <!-- TextElement.Foreground inherits the color to all children unless they override it -->
               <Grid TextElement.Foreground="{Binding TextColor}">
                   <Grid.ColumnDefinitions>
                       <ColumnDefinition Width="{Binding TreePaneWidth, Mode=TwoWay}" MinWidth="100" />
                       <ColumnDefinition Width="5" />
                       <ColumnDefinition Width="*" />
                       <ColumnDefinition Width="5" />
                       <ColumnDefinition Width="{Binding DetailPaneWidth, Mode=TwoWay}" MinWidth="200" />
                   </Grid.ColumnDefinitions>

                   <!-- LEFT CONTENT (column 0) -->
                   <!-- Bind Background to PanelBackground -->
                   <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="0,0,1,0" 
                           Background="{Binding PanelBackground}">

                       <!-- We're putting the TreeView and header into a grid -->
                       <Grid RowDefinitions="Auto, *">

                           <!-- Header bar with settings button -->
                           <!-- CORRECTED: Added one more "Car" column -->
                           <Grid Grid.Row="0" ColumnDefinitions="*, Auto, Auto, Auto, Auto" Margin="10">
                               <TextBlock Text="{x:Static p:Strings.Media_Library}" 
                                          FontWeight="Bold" FontSize="16" VerticalAlignment="Center"/>

                               <!-- Theme Toggle Button -->
                               <Button Grid.Column="1"
                                       Command="{Binding ToggleThemeCommand}"
                                       Background="Transparent" BorderThickness="0"
                                       ToolTip.Tip="{x:Static p:Strings.Toggle_Theme}"
                                       Cursor="Hand" Margin="0,0,5,0"
                                       Foreground="{Binding TextColor}">
                                   <PathIcon Data="{StaticResource IconThemeToggle}"
                                             Width="16" Height="16" />
                               </Button>

                               <!-- Search button integrated into the header -->
                               <Button Grid.Column="2"
                                       Command="{Binding OpenSearchCommand}"
                                       Background="Transparent" BorderThickness="0"
                                       ToolTip.Tip="{x:Static p:Strings.Search_Global}"
                                       Cursor="Hand" Margin="0,2,5,0"
                                       Foreground="{Binding TextColor}">
                                   <PathIcon Data="{StaticResource IconSearch}"
                                             Width="16" Height="16" />
                               </Button>

                               <!-- BIG MODE BUTTON -->
                               <Button Grid.Column="3"
                                       Command="{Binding EnterBigModeCommand}"
                                       Background="Transparent" BorderThickness="0"
                                       ToolTip.Tip="Big Picture Mode"
                                       Cursor="Hand" Margin="0,2,5,0"
                                       Foreground="{Binding TextColor}">
                                   <PathIcon Data="{StaticResource IconTv}"
                                             Width="16" Height="16" />
                               </Button>

                               <Button Grid.Column="4"
                                       Command="{Binding OpenSettingsCommand}"
                                       Background="Transparent" BorderThickness="0"
                                       ToolTip.Tip="{x:Static p:Strings.Settings_Title}"
                                       Cursor="Hand"
                                       Foreground="{Binding TextColor}">
                                   <PathIcon Data="{StaticResource IconSettings}"
                                             Width="16" Height="16" />
                               </Button>
                           </Grid>

                           <!-- The actual tree -->
                           <TreeView x:Name="Tree" Grid.Row="1"
                                     ItemsSource="{Binding RootItems}"
                                     SelectedItem="{Binding SelectedNode, Mode=TwoWay}" Background="Transparent">

                               <TreeView.ContextMenu>
                                   <ContextMenu>
                                       <MenuItem Header="{x:Static p:Strings.Ctx_Category_Add}"
                                                 Command="{Binding AddCategoryCommand}"
                                                 CommandParameter="{x:Null}" /> <!-- Null = Root -->
                                   </ContextMenu>
                               </TreeView.ContextMenu>

                               <TreeView.Styles>
                                   <Style Selector="TreeViewItem">
                                       <Setter x:DataType="models:MediaNode" Property="IsExpanded"
                                               Value="{Binding IsExpanded, Mode=TwoWay}" />
                                       <!-- Set text color explicitly, as TreeViewItem sometimes has its own styles -->
                                       <Setter Property="Foreground" Value="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).TextColor}" />
                                   </Style>
                                   <Style Selector="TreeView Border.tree-node">
                                       <Setter Property="Background" Value="Transparent" />
                                       <Setter Property="BorderBrush" Value="Transparent" />
                                       <Setter Property="BorderThickness" Value="0" />
                                       <Setter Property="Padding" Value="2,1" />
                                   </Style>
                                   <Style Selector="TreeView Border.tree-node.drop-before">
                                       <Setter Property="BorderBrush" Value="#88FFFFFF" />
                                       <Setter Property="BorderThickness" Value="0,2,0,0" />
                                   </Style>
                                   <Style Selector="TreeView Border.tree-node.drop-after">
                                       <Setter Property="BorderBrush" Value="#88FFFFFF" />
                                       <Setter Property="BorderThickness" Value="0,0,0,2" />
                                   </Style>
                                   <Style Selector="TreeView Border.tree-node.drop-inside">
                                       <Setter Property="Background" Value="#22FFFFFF" />
                                       <Setter Property="BorderBrush" Value="#66FFFFFF" />
                                       <Setter Property="BorderThickness" Value="1" />
                                   </Style>
                               </TreeView.Styles>
                               <TreeView.ItemTemplate>
                                   <!-- TreeDataTemplate for the nodes -->
                                   <TreeDataTemplate x:DataType="models:MediaNode" ItemsSource="{Binding Children}">
                                       <Border Classes="tree-node"
                                             PointerPressed="OnTreeNodePointerPressed"
                                             PointerMoved="OnTreeNodePointerMoved"
                                             PointerReleased="OnTreeNodePointerReleased"
                                             input:DragDrop.DragOver="OnTreeNodeDragOver"
                                             input:DragDrop.DragLeave="OnTreeNodeDragLeave"
                                             input:DragDrop.Drop="OnTreeNodeDrop"
                                             input:DragDrop.AllowDrop="True">
                                           <Border.ContextMenu>
                                               <ContextMenu>
                                                   <!-- SIMPLIFIED & LOCALIZED -->
                                                   <MenuItem Header="{x:Static p:Strings.Ctx_Category_Add}"
                                                             Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).AddCategoryCommand}"
                                                             CommandParameter="{Binding .}" />

                                                   <Separator />

                                                   <!-- IMPORT SUBMENU -->
                                                   <MenuItem Header="{x:Static p:Strings.Button_Import}" FontWeight="Bold">
                                                       <MenuItem Header="{x:Static p:Strings.Import_Roms}"
                                                                 Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ImportRomsCommand}"
                                                                 CommandParameter="{Binding .}"/>
                                                       <Separator/>
                                                       <MenuItem Header="{x:Static p:Strings.Import_Steam}"
                                                                 Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ImportSteamCommand}"
                                                                 CommandParameter="{Binding .}"/>
                                                       <MenuItem Header="{x:Static p:Strings.Import_Gog}"
                                                                 Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ImportGogCommand}"
                                                                 CommandParameter="{Binding .}"/>
                                                       <MenuItem Header="{x:Static p:Strings.Import_Epic}"
                                                                 Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ImportEpicCommand}"
                                                                 CommandParameter="{Binding .}"/>
                                                   </MenuItem>
                                                   <MenuItem Header="{x:Static p:Strings.Metadata_SearchMetadataAll}"
                                                             Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ScrapeNodeCommand}"
                                                             CommandParameter="{Binding .}"
                                                             FontWeight="Bold" />
                                                   <Separator/>
                                                   <MenuItem Header="{x:Static p:Strings.Ctx_Media_Add}"
                                                             Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).AddMediaCommand}"
                                                             CommandParameter="{Binding .}"
                                                             FontWeight="Bold" />

                                                   <Separator/>

                                                   <!-- Settings for the folder -->
                                                   <MenuItem Header="{x:Static p:Strings.Media_Settings}"
                                                             Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).EditNodeCommand}"
                                                             CommandParameter="{Binding .}"/>

                                                   <Separator />

                                                   <MenuItem Header="{x:Static p:Strings.Button_Delete}"
                                                             Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).DeleteCommand}"
                                                             CommandParameter="{Binding .}"
                                                             Foreground="Red" />
                                               </ContextMenu>
                                           </Border.ContextMenu>

                                           <TextBlock Text="{Binding Name}" VerticalAlignment="Center" />
                                       </Border>
                                   </TreeDataTemplate>
                               </TreeView.ItemTemplate>
                           </TreeView>
                       </Grid>
                   </Border>

                   <!-- Splitter 1 -->
                   <GridSplitter Grid.Column="1" Width="5" Background="#DDDDDD" Opacity="0.5" ResizeBehavior="PreviousAndNext" />

                   <!-- MIDDLE CONTENT (column 2) -->
                   <!-- Remove the background so the wallpaper shows through completely -->
                   <Border Grid.Column="2" Background="Transparent"> <!-- Transparent! -->
                       <Grid>
                           <TextBlock Text="{x:Static p:Strings.Dialog_EmptyLibraryHint}"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"
                                      Foreground="{Binding TextColor}"
                                      FontSize="16"
                                      FontStyle="Italic"
                                      IsVisible="{Binding SelectedNodeContent, Converter={x:Static helpers:ObjectConverters.IsNull}}" />
                           <ContentControl Content="{Binding SelectedNodeContent}"
                                           IsVisible="{Binding SelectedNodeContent, Converter={x:Static helpers:ObjectConverters.IsNotNull}}" />
                       </Grid>
                   </Border>

                   <!-- Splitter 2 -->
                   <GridSplitter Grid.Column="3" Width="5" Background="#DDDDDD" Opacity="0.5" ResizeBehavior="PreviousAndNext" />

                   <!-- RIGHT CONTENT (column 4) -->
                   <!-- Attach background to panel background! -->
                   <Grid Grid.Column="4" Background="{Binding PanelBackground}" x:CompileBindings="False">
                       <Grid IsVisible="{Binding SelectedNodeContent, Converter={x:Static helpers:ObjectConverters.IsNotNull}}">
                           <TextBlock Text="{x:Static p:Strings.Dialog_ChooseMedia}"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"
                                      Foreground="{Binding DataContext.TextColor, ElementName=MainWin}"
                                      FontSize="16"
                                      FontStyle="Italic"
                                      IsVisible="{Binding SelectedNodeContent.SelectedMediaItem, Converter={x:Static ObjectConverters.IsNull}}" />

                           <!-- ... ContentControl and fallback as before ... -->
                           <ContentControl x:CompileBindings="False"
                                           Content="{Binding SelectedNodeContent.SelectedMediaItem}"
                                           IsVisible="{Binding SelectedNodeContent.SelectedMediaItem, Converter={x:Static ObjectConverters.IsNotNull}}">
                               <ContentControl.ContentTemplate>
                                   <DataTemplate DataType="models:MediaItem">
                                       <!-- Here, the background is transparent because the grid behind it already has the color -->
                                       <views:MediaDetailView Background="Transparent" />
                                   </DataTemplate>
                               </ContentControl.ContentTemplate>
                           </ContentControl>
                       </Grid>
                   </Grid>

               </Grid> <!-- End Grid -->
           </Grid>
       </Grid>

        <!-- Resize Grips (Invisible Edges) -->
        <!-- We use x:Static for WindowEdge. The Avalonia.Controls namespace is there by default -->
        <Grid RowDefinitions="5,*,5" ColumnDefinitions="5,*,5">
            <!-- Top Left -->
            <Rectangle Grid.Row="0" Grid.Column="0" Fill="Transparent" Cursor="TopLeftCorner" Tag="{x:Static WindowEdge.NorthWest}" PointerPressed="OnResizeDrag"/>
            <!-- Top -->
            <Rectangle Grid.Row="0" Grid.Column="1" Fill="Transparent" Cursor="TopSide" Tag="{x:Static WindowEdge.North}" PointerPressed="OnResizeDrag"/>
            <!-- Top Right -->
            <Rectangle Grid.Row="0" Grid.Column="2" Fill="Transparent" Cursor="TopRightCorner" Tag="{x:Static WindowEdge.NorthEast}" PointerPressed="OnResizeDrag"/>
            
            <!-- Left -->
            <Rectangle Grid.Row="1" Grid.Column="0" Fill="Transparent" Cursor="LeftSide" Tag="{x:Static WindowEdge.West}" PointerPressed="OnResizeDrag"/>
            <!-- Right -->
            <Rectangle Grid.Row="1" Grid.Column="2" Fill="Transparent" Cursor="RightSide" Tag="{x:Static WindowEdge.East}" PointerPressed="OnResizeDrag"/>
            
            <!-- Bottom Left -->
            <Rectangle Grid.Row="2" Grid.Column="0" Fill="Transparent" Cursor="BottomLeftCorner" Tag="{x:Static WindowEdge.SouthWest}" PointerPressed="OnResizeDrag"/>
            <!-- Bottom -->
            <Rectangle Grid.Row="2" Grid.Column="1" Fill="Transparent" Cursor="BottomSide" Tag="{x:Static WindowEdge.South}" PointerPressed="OnResizeDrag"/>
            <!-- Bottom Right -->
            <Rectangle Grid.Row="2" Grid.Column="2" Fill="Transparent" Cursor="BottomRightCorner" Tag="{x:Static WindowEdge.SouthEast}" PointerPressed="OnResizeDrag"/>
        </Grid>
       <!-- LAYER 2: BIG PICTURE OVERLAY -->
       <!-- This layer sits on top of everything. If Content is null, it should be invisible. -->
       <ContentControl Content="{Binding FullScreenContent}" 
                       IsVisible="{Binding FullScreenContent, Converter={x:Static ObjectConverters.IsNotNull}}"
                       Background="Black" /> 
    </Panel>
</Window>
