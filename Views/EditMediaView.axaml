<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Retromind.ViewModels"
        xmlns:m="clr-namespace:Retromind.Models;assembly=Retromind"
        xmlns:p="clr-namespace:Retromind.Resources"
        xmlns:helpers="clr-namespace:Retromind.Helpers"
        x:Class="Retromind.Views.EditMediaView"
        x:DataType="vm:EditMediaViewModel"
        Title="{x:Static p:Strings.Dialog_EditMedia}"
        Width="800" Height="800"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        CanResize="False">

    <Window.Resources>
        <helpers:MediaTypeToLocalizedNameConverter x:Key="MediaTypeConverter" />
    </Window.Resources>

    <!-- Grid füllt das Fenster -->
    <Grid RowDefinitions="*, Auto" Margin="10">

        <TabControl Grid.Row="0">
            <!-- TAB 1: METADATEN -->
            <TabItem Header="Allgemein" FontSize="16">
                <!-- FIX: Padding vom ScrollViewer entfernt -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="15" Margin="10,10,20,50">
                        <!-- Titel -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Common_Title}" FontWeight="Bold" Margin="0,0,0,5" />
                            <TextBox Text="{Binding Title}" />
                        </StackPanel>

                        <!-- Developer & Genre -->
                        <Grid ColumnDefinitions="*, 15, *">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{x:Static p:Strings.Common_Developer}" FontWeight="Bold" Margin="0,0,0,5" />
                                <TextBox Text="{Binding Developer}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{x:Static p:Strings.Common_Genre}" FontWeight="Bold" Margin="0,0,0,5" />
                                <TextBox Text="{Binding Genre}" />
                            </StackPanel>
                        </Grid>

                        <!-- Datum & Status -->
                        <Grid ColumnDefinitions="*, 15, *">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{x:Static p:Strings.Common_ReleaseDate}" FontWeight="Bold" Margin="0,0,0,5" />
                                <DatePicker SelectedDate="{Binding ReleaseDate}" HorizontalAlignment="Stretch" />
                            </StackPanel>
                            
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{x:Static p:Strings.Common_Status}" FontWeight="Bold" Margin="0,0,0,5" />
                                <ComboBox ItemsSource="{Binding StatusOptions}"
                                          SelectedItem="{Binding Status}"
                                          HorizontalAlignment="Stretch" />
                            </StackPanel>
                        </Grid>

                        <!-- Beschreibung -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Common_Summary}" FontWeight="Bold" Margin="0,0,0,5" />
                            <TextBox Text="{Binding Description}"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     Height="100" />
                        </StackPanel>

                        <!-- TRENNLINIE -->
                        <Separator Opacity="0.5" Margin="0,10" />
                        <TextBlock Text="{x:Static p:Strings.Launch_Config}" FontWeight="Bold" FontSize="16" />

                        <!-- Start Methode -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Launch_Mode}" Margin="0,0,0,5" />
                            <ComboBox ItemsSource="{Binding MediaTypeOptions}"
                                      SelectedItem="{Binding MediaType}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource MediaTypeConverter}}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                        
                        <!-- Prozess Überwachung -->
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,5">
                                <TextBlock Text="{x:Static p:Strings.Process_Monitor}" VerticalAlignment="Center"/>
                                    
                                <!-- Ein schicker "Help Badge" -->
                                <Border Background="LightGray" CornerRadius="10" Width="18" Height="18" Margin="8,0,0,0"
                                        ToolTip.Tip="{x:Static p:Strings.Hint_TimePlayed}" 
                                        Cursor="Help">
                                    <TextBlock Text="?" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               FontSize="12" FontWeight="Bold" Foreground="Gray"/>
                                </Border>
                            </StackPanel>
                            <TextBox Text="{Binding OverrideWatchProcess}" Watermark="{x:Static p:Strings.Media_WatermarkOverrideWatchProcess}" />
                        </StackPanel>

                        <!-- Profil Auswahl -->
                        <StackPanel IsVisible="{Binding IsEmulatorMode}">
                            <TextBlock Text="{x:Static p:Strings.Profile_Profile}" Margin="0,10,0,5" />
                            <ComboBox ItemsSource="{Binding AvailableEmulators}"
                                      SelectedItem="{Binding SelectedEmulatorProfile}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- Custom launcher / tool path -->
                        <!-- Only visible for manual emulator (custom tool path).
                             Native uses wrapper chain now, so LauncherPath would be confusing. -->
                        <StackPanel IsVisible="{Binding IsManualEmulator}" Margin="0,10,0,0">
                            <TextBlock Text="{x:Static p:Strings.Launch_LauncherPath}" Margin="0,0,0,5" />
                            <Grid ColumnDefinitions="*, 10, Auto">
                                <TextBox Grid.Column="0"
                                         Text="{Binding LauncherPath}"
                                         Watermark="{x:Static p:Strings.Launch_LauncherPathHint}" />
                                <Button Grid.Column="2" Content="..." Command="{Binding BrowseLauncherCommand}" />
                            </Grid>
                        </StackPanel>

                        <!-- Arguments: always visible -->
                        <StackPanel Margin="0,15,0,0">
                            <TextBlock Text="{x:Static p:Strings.Launch_Arguments}" Margin="0,0,0,5" />

                            <TextBox IsVisible="{Binding IsNativeMode}"
                                     Text="{Binding LauncherArgs, Mode=TwoWay}"
                                     Watermark="{x:Static p:Strings.Launch_ArgumentsHintShort}" />

                            <TextBox IsVisible="{Binding !IsNativeMode}"
                                     Text="{Binding LauncherArgs, Mode=TwoWay}"
                                     Watermark="{x:Static p:Strings.Launch_ArgumentsHintLong}" />
                        </StackPanel>

                        <!-- Prefix (Wine/Proton/UMU) -->
                        <Expander Header="Prefix (Wine/Proton/UMU)" IsExpanded="False" Margin="0,10,0,0">
                            <StackPanel Spacing="10">
                                <TextBlock Opacity="0.7" FontSize="11"
                                           Text="Optional. Wenn gesetzt, wird WINEPREFIX beim Start verwendet. Für Native+Wrapper gilt: Prefix wird nur genutzt, wenn hier ein PrefixPath gesetzt ist." />

                                <StackPanel>
                                    <TextBlock Text="PrefixPath (relativ zu Library/)" FontWeight="Bold" />
                                    <TextBox Text="{Binding PrefixPath, Mode=TwoWay}"
                                             Watermark="Prefixes/itemId_Titel" />
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <Button Content="Generate"
                                            Command="{Binding GeneratePrefixCommand}" />
                                    <Button Content="Open Folder"
                                            Command="{Binding OpenPrefixFolderCommand}"
                                            IsEnabled="{Binding HasPrefix}" />
                                    <Button Content="Clear"
                                            Command="{Binding ClearPrefixCommand}"
                                            IsEnabled="{Binding HasPrefix}" />
                                </StackPanel>
                            </StackPanel>
                        </Expander>

                        <!-- Native wrapper chain (Linux) - Item-level -->
                        <StackPanel Spacing="8"
                                    Margin="0,15,0,0"
                                    IsVisible="{Binding IsNativeMode}">
                            <TextBlock Text="Native Wrapper (Linux)" FontWeight="Bold" />

                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <RadioButton Content="Inherit"
                                             IsChecked="{Binding IsNativeWrapperInherit, Mode=TwoWay}" />
                                <RadioButton Content="None"
                                             IsChecked="{Binding IsNativeWrapperNone, Mode=TwoWay}" />
                                <RadioButton Content="Override"
                                             IsChecked="{Binding IsNativeWrapperOverride, Mode=TwoWay}" />
                            </StackPanel>

                            <StackPanel IsVisible="{Binding IsNativeWrapperOverride}">
                                <Button Content="+ Add wrapper"
                                        Command="{Binding AddNativeWrapperCommand}"
                                        HorizontalAlignment="Left" />

                                <ItemsControl ItemsSource="{Binding NativeWrappers}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#10000000" CornerRadius="4" Padding="8" Margin="0,5,0,0">
                                                <Grid ColumnDefinitions="*, 10, *, 10, Auto" RowDefinitions="Auto, Auto">
                                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Path" />
                                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="Args" />

                                                    <TextBox Grid.Row="1" Grid.Column="0"
                                                             Text="{Binding Path, Mode=TwoWay}"
                                                             Watermark="gamemoderun / mangohud / env" />

                                                    <TextBox Grid.Row="1" Grid.Column="2"
                                                             Text="{Binding Args, Mode=TwoWay}" />

                                                    <StackPanel Grid.Row="1" Grid.Column="4" Orientation="Horizontal" Spacing="5">
                                                        <Button Content="↑"
                                                                ToolTip.Tip="Move up"
                                                                Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).MoveNativeWrapperUpCommand}"
                                                                CommandParameter="{Binding}" />
                                                        <Button Content="↓"
                                                                ToolTip.Tip="Move down"
                                                                Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).MoveNativeWrapperDownCommand}"
                                                                CommandParameter="{Binding}" />
                                                        <Button Content="✕"
                                                                Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).RemoveNativeWrapperCommand}"
                                                                CommandParameter="{Binding .}" />
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </StackPanel>
                        
                         <!-- Vorschau -->
                        <StackPanel>
                            <Grid ColumnDefinitions="*, Auto" Margin="0,10,0,5">
                                <TextBlock Grid.Column="0"
                                           Text="{x:Static p:Strings.Common_PreviewShort}"
                                           FontWeight="Bold" />

                                <Button Grid.Column="1"
                                        Content="Copy"
                                        Command="{Binding CopyPreviewCommand}"
                                        CommandParameter="{Binding $parent[Window]}"
                                        ToolTip.Tip="Copy preview command"
                                        Padding="10,2"
                                        HorizontalAlignment="Right" />
                            </Grid>

                            <Border Background="#333333" CornerRadius="5" Padding="10">
                                <TextBlock Text="{Binding PreviewText}"
                                           FontFamily="Consolas, Monospace"
                                           Foreground="#00FF00"
                                           TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 2: MEDIEN -->
            <TabItem Header="Medien (Assets)" FontSize="16">
                <Grid RowDefinitions="Auto, *, Auto" Margin="0,10,0,0">
                    
                    <!-- Toolbar Oben: Import Buttons -->
                    <Border Grid.Row="0" Background="#10000000" CornerRadius="4" Padding="5" Margin="0,0,0,10">
                        <WrapPanel Orientation="Horizontal">
                            <!-- Wir nutzen CommandParameter für die AssetTypes -->
                            <Button Content="+ Cover" Command="{Binding ImportAssetCommand}" CommandParameter="{x:Static m:AssetType.Cover}" Margin="0,0,5,5"/>
                            <Button Content="+ Wallpaper" Command="{Binding ImportAssetCommand}" CommandParameter="{x:Static m:AssetType.Wallpaper}" Margin="0,0,5,5"/>
                            <Button Content="+ Logo" Command="{Binding ImportAssetCommand}" CommandParameter="{x:Static m:AssetType.Logo}" Margin="0,0,5,5"/>
                            <Button Content="+ Video" Command="{Binding ImportAssetCommand}" CommandParameter="{x:Static m:AssetType.Video}" Margin="0,0,5,5"/>
                            <Button Content="+ Music" Command="{Binding ImportAssetCommand}" CommandParameter="{x:Static m:AssetType.Music}" Margin="0,0,5,5"/>
                            <Button Content="+ Marquee" Command="{Binding ImportAssetCommand}" CommandParameter="{x:Static m:AssetType.Marquee}" Margin="0,0,5,5"/>
                        </WrapPanel>
                    </Border>
                    
                    <!-- Liste aller Assets -->
                    <ListBox Grid.Row="1" ItemsSource="{Binding Assets}" SelectedItem="{Binding SelectedAsset}" Background="Transparent">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="m:MediaAsset">
                                <Border Width="140" Height="200" Margin="5" 
                                        BorderBrush="#40808080" BorderThickness="1" 
                                        CornerRadius="4" Background="#10000000">
                                    <Grid RowDefinitions="*, Auto">
                                        
                                        <!-- Vorschaubild (für Grafiken) -->
                                        <!-- Wir nutzen RelativePath, der AsyncImageHelper muss damit klarkommen. 
                                             Alternativ: Einen Converter im XAML nutzen, der Relative->Absolut macht. -->
                                        <Image Grid.Row="0" 
                                               helpers:AsyncImageHelper.Url="{Binding AbsolutePath}"
                                               Stretch="Uniform" Margin="5"/>
                                        
                                        <!-- Typ-Label -->
                                        <Border Grid.Row="1" Background="#80000000" Padding="5">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Type}" Foreground="White" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                <TextBlock Text="{Binding RelativePath}" Foreground="#CCC" FontSize="9" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding RelativePath}"/>
                                            </StackPanel>
                                        </Border>
                                        
                                        <!-- Indikator für Musik/Video wenn kein Bild -->
                                        <!-- Hier könnte man komplexe Trigger nutzen, aber für den MVP reicht Text -->
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Footer Toolbar: Löschen -->
                    <Border Grid.Row="2" Background="#15FF0000" CornerRadius="5" Margin="0,10,0,0" Padding="10">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="Wähle ein Asset zum Löschen" VerticalAlignment="Center" FontStyle="Italic" Foreground="Gray"
                                       IsVisible="{Binding SelectedAsset, Converter={x:Static ObjectConverters.IsNull}}"/>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" IsVisible="{Binding SelectedAsset, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <TextBlock Text="{Binding SelectedAsset.RelativePath, StringFormat='Lösche: {0}', TargetNullValue=''}" VerticalAlignment="Center" Foreground="Red"/>
                                <Button Content="{x:Static p:Strings.Button_Delete}" Command="{Binding DeleteAssetCommand}" 
                                        Foreground="White" Background="Red"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- HAUPT BUTTONS (Unten rechts) -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,10,0,0">
            <Button Content="{x:Static p:Strings.Button_Cancel}"
                    Command="{Binding CancelAndCloseCommand}"
                    CommandParameter="{Binding $parent[Window]}"
                    Width="100"
                    HorizontalContentAlignment="Center"
                    IsCancel="True" />
            <Button Content="{x:Static p:Strings.Button_Save}"
                    Command="{Binding SaveAndCloseCommand}"
                    CommandParameter="{Binding $parent[Window]}"
                    Classes="accent"
                    Width="100"
                    HorizontalContentAlignment="Center"
                    IsDefault="True" />
        </StackPanel>
    </Grid>
</Window>