<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Retromind.ViewModels"
        xmlns:m="clr-namespace:Retromind.Models;assembly=Retromind"
        xmlns:p="clr-namespace:Retromind.Resources"
        xmlns:helpers="clr-namespace:Retromind.Helpers"
        x:Class="Retromind.Views.EditMediaView"
        x:DataType="vm:EditMediaViewModel"
        Title="{x:Static p:Strings.Dialog_EditMedia}"
        Width="800" Height="800"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        CanResize="False">

    <Window.Resources>
        <helpers:MediaTypeToLocalizedNameConverter x:Key="MediaTypeConverter" />
    </Window.Resources>

    <!-- Main grid filling the window -->
    <Grid RowDefinitions="*, Auto" Margin="10">

        <TabControl Grid.Row="0">
            <!-- TAB 1: METADATA -->
            <TabItem Header="{x:Static p:Strings.EditMedia_Tab_General}" FontSize="16">
                <!-- Removed extra padding from ScrollViewer for a tighter layout -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="15" Margin="10,10,20,50">
                        <!-- Title -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Common_Title}" FontWeight="Bold" Margin="0,0,0,5" />
                            <TextBox Text="{Binding Title}" />
                        </StackPanel>

                        <!-- Developer & Genre -->
                        <Grid ColumnDefinitions="*, 15, *">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{x:Static p:Strings.Common_Developer}" FontWeight="Bold" Margin="0,0,0,5" />
                                <TextBox Text="{Binding Developer}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{x:Static p:Strings.Common_Genre}" FontWeight="Bold" Margin="0,0,0,5" />
                                <TextBox Text="{Binding Genre}" />
                            </StackPanel>
                        </Grid>

                        <!-- Release date & Status -->
                        <Grid ColumnDefinitions="*, 15, *">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{x:Static p:Strings.Common_ReleaseDate}" FontWeight="Bold" Margin="0,0,0,5" />
                                <DatePicker SelectedDate="{Binding ReleaseDate}" HorizontalAlignment="Stretch" />
                            </StackPanel>
                            
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{x:Static p:Strings.Common_Status}" FontWeight="Bold" Margin="0,0,0,5" />
                                <ComboBox ItemsSource="{Binding StatusOptions}"
                                          SelectedItem="{Binding Status}"
                                          HorizontalAlignment="Stretch" />
                            </StackPanel>
                        </Grid>

                        <!-- Description -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Common_Summary}" FontWeight="Bold" Margin="0,0,0,5" />
                            <TextBox Text="{Binding Description}"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     Height="100" />
                        </StackPanel>

                        <!-- Separator -->
                        <Separator Opacity="0.5" Margin="0,10" />
                        <TextBlock Text="{x:Static p:Strings.Launch_Config}" FontWeight="Bold" FontSize="16" />

                        <!-- Launch mode -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Launch_Mode}" Margin="0,0,0,5" />
                            <ComboBox ItemsSource="{Binding MediaTypeOptions}"
                                      SelectedItem="{Binding MediaType}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource MediaTypeConverter}}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- Primary launch file (native/exe/ROM) -->
                        <StackPanel Margin="0,10,0,0">
                            <TextBlock Text="Launch file" Margin="0,0,0,5" />
                            <Grid ColumnDefinitions="*, 10, Auto">
                                <TextBox Grid.Column="0"
                                         Text="{Binding PrimaryFileDisplayPath}"
                                         IsReadOnly="True"
                                         Watermark="No launch file selected" />
                                <Button Grid.Column="2"
                                        Content="Change..."
                                        Command="{Binding ChangePrimaryFileCommand}" />
                            </Grid>
                        </StackPanel>
                        
                        <!-- Process monitoring -->
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,5">
                                <TextBlock Text="{x:Static p:Strings.Process_Monitor}" VerticalAlignment="Center"/>
            
                                <!-- Small help badge with tooltip for playtime tracking hint -->
                                <Border Background="LightGray" CornerRadius="10" Width="18" Height="18" Margin="8,0,0,0"
                                        ToolTip.Tip="{x:Static p:Strings.Hint_TimePlayed}" 
                                        Cursor="Help">
                                    <TextBlock Text="?" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               FontSize="12" FontWeight="Bold" Foreground="Gray"/>
                                </Border>
                            </StackPanel>
                            <TextBox Text="{Binding OverrideWatchProcess}" Watermark="{x:Static p:Strings.Media_WatermarkOverrideWatchProcess}" />
                        </StackPanel>

                        <!-- Emulator profile selection -->
                        <StackPanel IsVisible="{Binding IsEmulatorMode}">
                            <TextBlock Text="{x:Static p:Strings.Profile_Profile}" Margin="0,10,0,5" />
                            <ComboBox ItemsSource="{Binding AvailableEmulators}"
                                      SelectedItem="{Binding SelectedEmulatorProfile}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- Custom launcher / tool path -->
                        <!-- Only visible for manual emulator (custom tool path).
                             Native uses wrapper chain now, so LauncherPath would be confusing. -->
                        <StackPanel IsVisible="{Binding IsManualEmulator}" Margin="0,10,0,0">
                            <TextBlock Text="{x:Static p:Strings.Launch_LauncherPath}" Margin="0,0,0,5" />
                            <Grid ColumnDefinitions="*, 10, Auto">
                                <TextBox Grid.Column="0"
                                         Text="{Binding LauncherPath}"
                                         Watermark="{x:Static p:Strings.Launch_LauncherPathHint}" />
                                <Button Grid.Column="2" Content="..." Command="{Binding BrowseLauncherCommand}" />
                            </Grid>
                        </StackPanel>

                        <!-- Arguments: always visible -->
                        <StackPanel Margin="0,15,0,0">
                            <TextBlock Text="{x:Static p:Strings.Launch_Arguments}" Margin="0,0,0,5" />

                            <TextBox IsVisible="{Binding IsNativeMode}"
                                     Text="{Binding LauncherArgs, Mode=TwoWay}"
                                     Watermark="{x:Static p:Strings.Launch_ArgumentsHintShort}" />

                            <TextBox IsVisible="{Binding !IsNativeMode}"
                                     Text="{Binding LauncherArgs, Mode=TwoWay}"
                                     Watermark="{x:Static p:Strings.Launch_ArgumentsHintLong}" />
                        </StackPanel>

                        <!-- Prefix (Wine/Proton/UMU) -->
                        <Expander Header="Prefix (Wine/Proton/UMU)" IsExpanded="False" Margin="0,10,0,0" HorizontalAlignment="Stretch">
                            <StackPanel Spacing="10">
                                <TextBlock Opacity="0.7" FontSize="11"
                                           Text="Optional. If set, WINEPREFIX will be used when launching. For Native+Wrapper: the prefix is applied only when PrefixPath is set here." />

                                <StackPanel>
                                    <TextBlock Text="PrefixPath (relative to Library/)" FontWeight="Bold" />
                                    <TextBox Text="{Binding PrefixPath, Mode=TwoWay}"
                                             Watermark="Prefixes/itemId_Title" />
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <Button Content="Generate"
                                            Command="{Binding GeneratePrefixCommand}" />
                                    <Button Content="Open Folder"
                                            Command="{Binding OpenPrefixFolderCommand}"
                                            IsEnabled="{Binding HasPrefix}" />
                                    <Button Content="Clear"
                                            Command="{Binding ClearPrefixCommand}"
                                            IsEnabled="{Binding HasPrefix}" />
                                </StackPanel>
                            </StackPanel>
                        </Expander>

                        <!-- Per-item environment variables -->
                        <Expander Header="Environment (per item)" IsExpanded="False" Margin="0,10,0,0" HorizontalAlignment="Stretch">
                            <StackPanel Spacing="6">
                                <TextBlock Text="Optional key/value pairs applied to the launched process."
                                           Opacity="0.7" FontSize="11"/>

                                <ItemsControl ItemsSource="{Binding EnvironmentOverrides}"
                                              HorizontalAlignment="Stretch">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="2*, 3*, Auto" Margin="0,2,0,2" HorizontalAlignment="Stretch">
                                                <TextBox Grid.Column="0"
                                                         Text="{Binding Key, Mode=TwoWay}"
                                                         Watermark="VAR_NAME (e.g. PROTONPATH)" />
                                                <TextBox Grid.Column="1"
                                                         Text="{Binding Value, Mode=TwoWay}"
                                                         Margin="4,0,4,0"
                                                         Watermark="value" />
                                                <Button Grid.Column="2"
                                                        Content="✕"
                                                        Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).RemoveEnvironmentVariableCommand}"
                                                        CommandParameter="{Binding .}" />
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <Button Content="+ Add variable"
                                        Command="{Binding AddEnvironmentVariableCommand}"
                                        HorizontalAlignment="Left" />
                            </StackPanel>
                        </Expander>
                        
                        <!-- Native wrapper chain (Linux) - item-level override -->
                        <StackPanel Spacing="8"
                                    Margin="0,15,0,0"
                                    IsVisible="{Binding IsNativeMode}">
                            <TextBlock Text="Native Wrapper (Linux)" FontWeight="Bold" />

                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <RadioButton Content="Inherit"
                                             IsChecked="{Binding IsNativeWrapperInherit, Mode=TwoWay}" />
                                <RadioButton Content="None"
                                             IsChecked="{Binding IsNativeWrapperNone, Mode=TwoWay}" />
                                <RadioButton Content="Override"
                                             IsChecked="{Binding IsNativeWrapperOverride, Mode=TwoWay}" />
                            </StackPanel>

                            <StackPanel IsVisible="{Binding IsNativeWrapperOverride}">
                                <Button Content="+ Add wrapper"
                                        Command="{Binding AddNativeWrapperCommand}"
                                        HorizontalAlignment="Left" />

                                <ItemsControl ItemsSource="{Binding NativeWrappers}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#10000000" CornerRadius="4" Padding="8" Margin="0,5,0,0">
                                                <Grid ColumnDefinitions="*, 10, *, 10, Auto" RowDefinitions="Auto, Auto">
                                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Path" />
                                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="Args" />

                                                    <TextBox Grid.Row="1" Grid.Column="0"
                                                             Text="{Binding Path, Mode=TwoWay}"
                                                             Watermark="gamemoderun / mangohud / env" />

                                                    <TextBox Grid.Row="1" Grid.Column="2"
                                                             Text="{Binding Args, Mode=TwoWay}" />

                                                    <StackPanel Grid.Row="1" Grid.Column="4" Orientation="Horizontal" Spacing="5">
                                                        <Button Content="↑"
                                                                ToolTip.Tip="Move up"
                                                                Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).MoveNativeWrapperUpCommand}"
                                                                CommandParameter="{Binding}" />
                                                        <Button Content="↓"
                                                                ToolTip.Tip="Move down"
                                                                Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).MoveNativeWrapperDownCommand}"
                                                                CommandParameter="{Binding}" />
                                                        <Button Content="✕"
                                                                Command="{Binding $parent[Window].((vm:EditMediaViewModel)DataContext).RemoveNativeWrapperCommand}"
                                                                CommandParameter="{Binding .}" />
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- Command preview section -->
                        <StackPanel>
                            <Grid ColumnDefinitions="*, Auto" Margin="0,10,0,5">
                                <TextBlock Grid.Column="0"
                                           Text="{x:Static p:Strings.Common_PreviewShort}"
                                           FontWeight="Bold" />

                                <Button Grid.Column="1"
                                        Content="Copy"
                                        Command="{Binding CopyPreviewCommand}"
                                        CommandParameter="{Binding $parent[Window]}"
                                        ToolTip.Tip="Copy preview command"
                                        Padding="10,2"
                                        HorizontalAlignment="Right" />
                            </Grid>

                            <Border Background="#333333" CornerRadius="5" Padding="10">
                                <TextBlock Text="{Binding PreviewText}"
                                           FontFamily="Consolas, Monospace"
                                           Foreground="#00FF00"
                                           TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 2: MEDIA -->
            <TabItem Header="{x:Static p:Strings.EditMedia_Tab_MediaAssets}" FontSize="16">
                <Grid RowDefinitions="Auto, *, Auto" Margin="0,10,0,0">
                    
                    <!-- Top toolbar: import buttons for different asset types -->
                    <Border Grid.Row="0" Background="#10000000" CornerRadius="4" Padding="5" Margin="0,0,0,10">
                        <WrapPanel Orientation="Horizontal">
                            <!-- Use CommandParameter to distinguish asset types -->
                            <Button Content="{x:Static p:Strings.Button_Cover}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Cover}"
                                    Margin="0,0,5,5"/>
                            <Button Content="{x:Static p:Strings.Button_Wall}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Wallpaper}"
                                    Margin="0,0,5,5"/>
                            <Button Content="{x:Static p:Strings.Button_Logo}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Logo}"
                                    Margin="0,0,5,5"/>
                            <Button Content="{x:Static p:Strings.FileType_Videos}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Video}"
                                    Margin="0,0,5,5"/>
                            <Button Content="{x:Static p:Strings.Media_AddMusic}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Music}"
                                    Margin="0,0,5,5"/>
                            <Button Content="Marquee"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Marquee}"
                                    Margin="0,0,5,5"/>
                            <Button Content="{x:Static p:Strings.Button_Bezel}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.Bezel}"
                                    Margin="0,0,5,5"/>
                            <Button Content="{x:Static p:Strings.Button_ControlPanel}"
                                    Command="{Binding ImportAssetCommand}"
                                    CommandParameter="{x:Static m:AssetType.ControlPanel}"
                                    Margin="0,0,5,5"/>
                        </WrapPanel>
                    </Border>
                    
                    <!-- Asset list -->
                    <ListBox Grid.Row="1" ItemsSource="{Binding Assets}" SelectedItem="{Binding SelectedAsset}" Background="Transparent">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="m:MediaAsset">
                                <Border Width="140" Height="200" Margin="5" 
                                        BorderBrush="#40808080" BorderThickness="1" 
                                        CornerRadius="4" Background="#10000000">
                                    <Grid RowDefinitions="*, Auto">
                                        
                                        <!-- Preview image (for image-like assets) -->
                                        <Image Grid.Row="0" 
                                               helpers:AsyncImageHelper.Url="{Binding AbsolutePath}"
                                               Stretch="Uniform" Margin="5"/>
                                        
                                        <!-- Type label + relative path -->
                                        <Border Grid.Row="1" Background="#80000000" Padding="5">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Type}" Foreground="White" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                <TextBlock Text="{Binding RelativePath}" Foreground="#CCC" FontSize="9" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding RelativePath}"/>
                                            </StackPanel>
                                        </Border>
                                        
                                        <!-- Additional indicators for music/video could be shown here if no image is available -->
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Footer toolbar: delete asset -->
                    <Border Grid.Row="2" Background="#15FF0000" CornerRadius="5" Margin="0,10,0,0" Padding="10">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="Select an asset to delete" VerticalAlignment="Center" FontStyle="Italic" Foreground="Gray"
                                       IsVisible="{Binding SelectedAsset, Converter={x:Static ObjectConverters.IsNull}}"/>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" IsVisible="{Binding SelectedAsset, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <TextBlock Text="{Binding SelectedAsset.RelativePath, StringFormat='Delete: {0}', TargetNullValue=''}" VerticalAlignment="Center" Foreground="Red"/>
                                <Button Content="{x:Static p:Strings.Button_Delete}" Command="{Binding DeleteAssetCommand}" 
                                        Foreground="White" Background="Red"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Main dialog buttons (bottom-right) -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,10,0,0">
            <Button Content="{x:Static p:Strings.Button_Cancel}"
                    Command="{Binding CancelAndCloseCommand}"
                    CommandParameter="{Binding $parent[Window]}"
                    Width="100"
                    HorizontalContentAlignment="Center"
                    IsCancel="True" />
            <Button Content="{x:Static p:Strings.Button_Save}"
                    Command="{Binding SaveAndCloseCommand}"
                    CommandParameter="{Binding $parent[Window]}"
                    Classes="accent"
                    Width="100"
                    HorizontalContentAlignment="Center"
                    IsDefault="True" />
        </StackPanel>
    </Grid>
</Window>