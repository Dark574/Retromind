<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Retromind.ViewModels"
        xmlns:p="clr-namespace:Retromind.Resources"
        xmlns:helpers="clr-namespace:Retromind.Helpers"
        x:Class="Retromind.Views.EditMediaView"
        x:DataType="vm:EditMediaViewModel"
        Title="{x:Static p:Strings.EditMediaTitle}"
        Width="700" Height="800"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <helpers:MediaTypeToLocalizedNameConverter x:Key="MediaTypeConverter" />
        <helpers:BitmapAssetValueConverter x:Key="PathToBitmapConverter" />
    </Window.Resources>

    <!-- Grid fÃ¼llt das Fenster -->
    <Grid RowDefinitions="*, Auto" Margin="10">

        <TabControl Grid.Row="0">
            <!-- TAB 1: METADATEN -->
            <TabItem Header="Allgemein" FontSize="16">
                <!-- FIX: Padding vom ScrollViewer entfernt -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <!-- FIX: Margin unten auf 80 gesetzt. 
                         Das zwingt den ScrollViewer, weiter nach unten zu scrollen, 
                         selbst wenn neue Felder aufklappen. -->
                    <StackPanel Spacing="15" Margin="10,10,20,50">
                        <!-- Titel -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Title}" FontWeight="Bold" Margin="0,0,0,5" />
                            <TextBox Text="{Binding Title}" />
                        </StackPanel>

                        <!-- Developer & Genre -->
                        <Grid ColumnDefinitions="*, 15, *">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{x:Static p:Strings.Developer}" FontWeight="Bold" Margin="0,0,0,5" />
                                <TextBox Text="{Binding Developer}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{x:Static p:Strings.Genre}" FontWeight="Bold" Margin="0,0,0,5" />
                                <TextBox Text="{Binding Genre}" />
                            </StackPanel>
                        </Grid>

                        <!-- Datum & Status -->
                        <Grid ColumnDefinitions="*, 15, *">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{x:Static p:Strings.ReleaseDate}" FontWeight="Bold" Margin="0,0,0,5" />
                                <DatePicker SelectedDate="{Binding ReleaseDate}" HorizontalAlignment="Stretch" />
                            </StackPanel>
                            
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="{x:Static p:Strings.Status}" FontWeight="Bold" Margin="0,0,0,5" />
                                <ComboBox ItemsSource="{Binding StatusOptions}"
                                          SelectedItem="{Binding Status}"
                                          HorizontalAlignment="Stretch" />
                            </StackPanel>
                        </Grid>

                        <!-- Beschreibung -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Summary}" FontWeight="Bold" Margin="0,0,0,5" />
                            <TextBox Text="{Binding Description}"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     Height="100" />
                        </StackPanel>

                        <!-- TRENNLINIE -->
                        <Separator Opacity="0.5" Margin="0,10" />
                        <TextBlock Text="{x:Static p:Strings.LaunchConfig}" FontWeight="Bold" FontSize="16" />

                        <!-- Start Methode -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.LaunchMode}" Margin="0,0,0,5" />
                            <ComboBox ItemsSource="{Binding MediaTypeOptions}"
                                      SelectedItem="{Binding MediaType}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource MediaTypeConverter}}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                        
                        <!-- Prozess Ãœberwachung (Optional) -->
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,5">
                                <TextBlock Text="{x:Static p:Strings.ProcessMonitor}" VerticalAlignment="Center"/>
                                    
                                <!-- Ein schicker "Help Badge" -->
                                <Border Background="LightGray" CornerRadius="10" Width="18" Height="18" Margin="8,0,0,0"
                                        ToolTip.Tip="{x:Static p:Strings.TimePlayedHint}" 
                                        Cursor="Help">
                                    <TextBlock Text="?" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               FontSize="12" FontWeight="Bold" Foreground="Gray"/>
                                </Border>
                            </StackPanel>
                            <TextBox Text="{Binding OverrideWatchProcess}" Watermark="{x:Static p:Strings.WatermarkOverrideWatchProcess}" />
                        </StackPanel>

                        <!-- Profil Auswahl (Emulator) -->
                        <StackPanel IsVisible="{Binding IsEmulatorMode}">
                            <TextBlock Text="{x:Static p:Strings.Profile}" Margin="0,10,0,5" />
                            <ComboBox ItemsSource="{Binding AvailableEmulators}"
                                      SelectedItem="{Binding SelectedEmulatorProfile}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- Manuelle Pfade -->
                        <StackPanel IsVisible="{Binding IsManualEmulator}" Spacing="15" Margin="0,10,0,0">
                            <StackPanel>
                                <TextBlock Text="{x:Static p:Strings.LauncherPath}" Margin="0,0,0,5" />
                                <Grid ColumnDefinitions="*, 10, Auto">
                                    <TextBox Grid.Column="0" Text="{Binding LauncherPath}"
                                             Watermark="{x:Static p:Strings.LauncherPathHint}" />
                                    <Button Grid.Column="2" Content="..." Command="{Binding BrowseLauncherCommand}" />
                                </Grid>
                            </StackPanel>

                            <StackPanel>
                                <TextBlock Text="{x:Static p:Strings.Arguments}" Margin="0,0,0,5" />
                                <TextBox Text="{Binding LauncherArgs}" Watermark="{x:Static p:Strings.ArgumentsHint}" />
                            </StackPanel>
                        </StackPanel>
                        
                         <!-- Vorschau -->
                        <StackPanel>
                            <TextBlock Text="{x:Static p:Strings.Preview}" FontWeight="Bold" Margin="0,10,0,5" />
                            <Border Background="#333333" CornerRadius="5" Padding="10">
                                <TextBlock Text="{Binding PreviewText}"
                                           FontFamily="Consolas, Monospace"
                                           Foreground="#00FF00"
                                           TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 2: MEDIEN -->
            <TabItem Header="Medien" FontSize="16">
                <!-- Grid Aufteilung:
                     *: Bilder (Nimmt den Rest)
                     Auto: Toolbar Bilder
                     100: Musik (VERKLEINERT)
                     Auto: Toolbar Musik
                -->
                <Grid RowDefinitions="*, Auto, 100, Auto" Margin="0,10,0,0">
                    
                    <!-- 1. BILDER -->
                    <ListBox Grid.Row="0" ItemsSource="{Binding GalleryImages}" SelectedItem="{Binding SelectedGalleryImage}" Background="Transparent">
                         <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <!-- VERGRÃ–ÃŸERT: 120x175 -->
                                <Border Width="120" Height="175" Margin="10" 
                                        BorderBrush="#40808080" BorderThickness="1" 
                                        CornerRadius="4" Background="#10000000">
                                    <Grid>
                                        <Image Source="{Binding FilePath, Converter={StaticResource PathToBitmapConverter}}" 
                                               Stretch="Uniform" Margin="5,5,5,30"/>
                                        
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,5" Spacing="4">
                                            <Border Background="Green" CornerRadius="3" IsVisible="{Binding IsCover}"><TextBlock Text="COV" FontSize="11" FontWeight="Bold" Foreground="White" Padding="5,2"/></Border>
                                            <Border Background="Blue" CornerRadius="3" IsVisible="{Binding IsWallpaper}"><TextBlock Text="WALL" FontSize="11" FontWeight="Bold" Foreground="White" Padding="5,2"/></Border>
                                            <Border Background="Orange" CornerRadius="3" IsVisible="{Binding IsLogo}"><TextBlock Text="LOGO" FontSize="11" FontWeight="Bold" Foreground="White" Padding="5,2"/></Border>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Toolbar Bilder -->
                    <Border Grid.Row="1" Background="#15FFFFFF" CornerRadius="5" Margin="0,5,0,15" Padding="5">
                        <Grid ColumnDefinitions="Auto, *, Auto">
                            <!-- Linke Seite: HinzufÃ¼gen / Importieren -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="5">
                                <!-- Direkte Imports -->
                                <Button Content="Imp. Cover" Command="{Binding ImportCoverCommand}" FontSize="11" 
                                        ToolTip.Tip="Importiert Bilder direkt als Cover in den Medien-Ordner" />
                                <Button Content="Imp. Wall" Command="{Binding ImportWallpaperCommand}" FontSize="11" 
                                        ToolTip.Tip="Importiert Bilder direkt als Wallpaper in den Medien-Ordner" />
                                <Button Content="Imp. Logo" Command="{Binding ImportLogoCommand}" FontSize="11" 
                                        ToolTip.Tip="Importiert Bilder direkt als Logo in den Medien-Ordner" />
                            </StackPanel>

                            <!-- Rechte Seite: Aktionen auf Auswahl -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
                                <Button Content="{x:Static p:Strings.Cover}" Command="{Binding SetAsCoverCommand}" FontSize="11"/>
                                <Button Content="{x:Static p:Strings.Wall}" Command="{Binding SetAsWallpaperCommand}" FontSize="11"/>
                                <Button Content="{x:Static p:Strings.Logo}" Command="{Binding SetAsLogoCommand}" FontSize="11"/>
                                
                                <Rectangle Width="1" Fill="#40808080" Margin="5,4"/>
                                
                                <!-- LÃ¶schen Button -->
                                <Button Content="{x:Static p:Strings.CtxDelete}" Command="{Binding RemoveImageCommand}" 
                                        Foreground="Red" Background="#15FF0000"
                                        ToolTip.Tip="LÃ¶scht die Datei unwiderruflich von der Festplatte!"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- 2. MUSIK (Begrenzte HÃ¶he 100) -->
                    <Grid Grid.Row="2" RowDefinitions="Auto, *">
                        <TextBlock Grid.Row="0" Text="{x:Static p:Strings.MusicFiles}" FontWeight="Bold" Margin="5,0,0,5"/>
                        <Border Grid.Row="1" BorderBrush="#40808080" BorderThickness="1" CornerRadius="4">
                            <ListBox ItemsSource="{Binding AvailableMusic}" SelectedItem="{Binding SelectedAudioItem}" Background="Transparent">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="30, *">
                                            <TextBlock Text="ðŸŽµ" VerticalAlignment="Center" FontSize="14"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0">
                                                <TextBlock Text="{Binding FileName}" FontWeight="SemiBold" FontSize="12"/>
                                                <TextBlock Text="{x:Static p:Strings.Active}" Foreground="Green" IsVisible="{Binding IsActive}" FontSize="10"/>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>
                    </Grid>

                    <!-- Toolbar Musik -->
                    <Border Grid.Row="3" Background="#15FFFFFF" CornerRadius="5" Margin="0,5,0,0" Padding="5">
                        <Grid ColumnDefinitions="Auto, *, Auto">
                            <!-- Linke Seite: Import -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                <Button Content="{x:Static p:Strings.AddMusic}" Command="{Binding AddMusicCommand}" 
                                        ToolTip.Tip="Importiert Musik direkt in den Medien-Ordner" />
                            </StackPanel>
                            
                            <!-- Rechte Seite: Aktionen -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                                <Button Content="{x:Static p:Strings.SetMusicActive}" Command="{Binding SetAsMusicCommand}" />
                                
                                <Rectangle Width="1" Fill="#40808080" Margin="0,4"/>
                                
                                <Button Content="{x:Static p:Strings.CtxDelete}" Command="{Binding RemoveMusicCommand}" 
                                        Foreground="Red" Background="#15FF0000"
                                        ToolTip.Tip="LÃ¶scht die Datei unwiderruflich von der Festplatte!"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- HAUPT BUTTONS (Unten rechts) -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,10,0,0">
            <Button Content="{x:Static p:Strings.Cancel}" Command="{Binding CancelCommand}" Width="100" HorizontalContentAlignment="Center"/>
            <Button Content="{x:Static p:Strings.Save}" Command="{Binding SaveCommand}" Classes="accent" Width="100" HorizontalContentAlignment="Center" IsDefault="True" />
        </StackPanel>
    </Grid>
</Window>