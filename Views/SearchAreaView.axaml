<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:Retromind.ViewModels"
             xmlns:models="clr-namespace:Retromind.Models"
             xmlns:p="clr-namespace:Retromind.Resources"
             xmlns:helpers="clr-namespace:Retromind.Helpers"
             x:Class="Retromind.Views.SearchAreaView"
             x:DataType="vm:SearchAreaViewModel"
             x:Name="Root">

    <Grid RowDefinitions="Auto, *">

        <!-- Header: Filters & controls -->
        <Border Grid.Row="0"
                Padding="10"
                Background="#10FFFFFF"
                Margin="0,0,0,10"
                CornerRadius="0,0,5,5">

            <Grid ColumnDefinitions="Auto, *, Auto">
                <!-- Titelzeile -->
                <TextBlock Grid.Column="0"
                           Text="{x:Static p:Strings.Search_GlobalShort}"
                           FontSize="20"
                           FontWeight="Bold"
                           VerticalAlignment="Center"/>


                <!-- Right aligned: filters and scopes -->
                <StackPanel Grid.Column="2"
                            Spacing="10"
                            HorizontalAlignment="Right">

                    <!-- Row 1: Unified search bar -->
                    <Grid ColumnDefinitions="Auto, 20, Auto, 20, Auto, 20, Auto, 20, Auto, 20, Auto, 20, Auto"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Right">

                        <!-- Random item from results -->
                        <Button Grid.Column="0"
                                Command="{Binding PlayRandomCommand}"
                                IsEnabled="{Binding HasResults}"
                                HorizontalAlignment="Left"
                                Padding="10,5">
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <TextBlock Text="ðŸŽ²"/>
                                <TextBlock Text="{x:Static p:Strings.Button_Random}"/>
                            </StackPanel>
                        </Button>

                        <!-- Favorites-only toggle -->
                        <CheckBox Grid.Column="2"
                                  IsChecked="{Binding OnlyFavorites}"
                                  VerticalAlignment="Center"
                                  ToolTip.Tip="{x:Static p:Strings.Common_FavoritesOnlyHint}">
                            <StackPanel Orientation="Horizontal" Spacing="3">
                                <TextBlock Text="â˜…"/>
                                <TextBlock Text="{x:Static p:Strings.Common_FavoritesOnly}"/>
                            </StackPanel>
                        </CheckBox>

                        <!-- Search title -->
                        <TextBox Grid.Column="4"
                                 Text="{Binding SearchText}"
                                 Watermark="{x:Static p:Strings.Dialog_TitleSearch}"
                                 Width="200"
                                 Height="28"
                                 VerticalContentAlignment="Center"/>

                        <!-- Year -->
                        <TextBox Grid.Column="6"
                                 Text="{Binding SearchYear}"
                                 Watermark="{x:Static p:Strings.Common_Year}"
                                 Width="150"
                                 Height="28"
                                 VerticalContentAlignment="Center"/>

                        <!-- Status filter + clear -->
                        <StackPanel Grid.Column="8"
                                    Orientation="Horizontal"
                                    Spacing="4"
                                    VerticalAlignment="Center">
                            <ComboBox ItemsSource="{Binding StatusOptions}"
                                      SelectedItem="{Binding SelectedStatusOption, Mode=TwoWay}"
                                      Width="130"
                                      Height="28"
                                      VerticalContentAlignment="Center"
                                      PlaceholderText="Status">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Label}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <!-- Clear status filter -->
                            <Button Width="22"
                                    Height="22"
                                    Padding="0"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    HorizontalContentAlignment="Center"
                                    VerticalContentAlignment="Center"
                                    Command="{Binding ResetFiltersCommand}"
                                    ToolTip.Tip="Reset all filters">
                                <TextBlock Text="âœ•"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Button>
                        </StackPanel>
                        
                        <!-- Zoom (tile size) -->
                        <StackPanel Grid.Column="10"
                                    Orientation="Horizontal"
                                    Spacing="6"
                                    VerticalAlignment="Center">
                            <TextBlock Text="{x:Static p:Strings.Zoom_Zoom}"
                                       VerticalAlignment="Center"/>
                            <Slider Value="{Binding ItemWidth}"
                                    Minimum="50"
                                    Maximum="300"
                                    Width="150"
                                    VerticalAlignment="Center"/>
                        </StackPanel>
                    </Grid>

                    <!-- Row 2: Scopes -->
                    <StackPanel Orientation="Horizontal"
                                Spacing="5"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Right">
                        <TextBlock Text="{x:Static p:Strings.Common_Area}"
                                   VerticalAlignment="Center"
                                   FontWeight="Bold"
                                   Margin="0,0,5,0"/>

                        <ItemsControl ItemsSource="{Binding Scopes}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding Node.Name}"
                                              IsChecked="{Binding IsSelected}"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Results -->
        <ListBox x:Name="ResultsList"
                 Grid.Row="1"
                 ItemsSource="{Binding ItemRows}"
                 Padding="0"
                 Background="Transparent"
                 IsVisible="{Binding HasResults}">
            <ListBox.Styles>
                <Style Selector="ListBoxItem">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter Content="{TemplateBinding Content}"
                                                  ContentTemplate="{TemplateBinding ContentTemplate}"
                                                  HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderBrush" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                    <Setter Property="Focusable" Value="False" />
                </Style>
                <Style Selector="ListBoxItem:pointerover">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderBrush" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                </Style>
                <Style Selector="ListBoxItem:selected">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderBrush" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                </Style>
                <Style Selector="ListBoxItem:focus">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderBrush" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                </Style>
            </ListBox.Styles>

            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <VirtualizingStackPanel />
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>

            <ListBox.ItemTemplate>
                <DataTemplate x:CompileBindings="False">
                    <ItemsControl ItemsSource="{Binding Items}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:CompileBindings="False">
                                <Border Width="{Binding DataContext.EffectiveItemWidth, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                        Height="{Binding DataContext.EffectiveItemWidth, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                        Margin="0,10"
                                        Padding="0,10"
                                        CornerRadius="0"
                                        ClipToBounds="True"
                                        PointerPressed="OnItemPointerPressed"
                                        DoubleTapped="OnItemDoubleTapped">

                                    <Border.Background>
                                        <MultiBinding Converter="{x:Static helpers:ObjectConverters.TileBackground}">
                                            <Binding />
                                            <Binding Path="DataContext.SelectedMediaItem"
                                                     RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                            <Binding Path="IsPointerOver"
                                                     RelativeSource="{RelativeSource Self}" />
                                        </MultiBinding>
                                    </Border.Background>
                                    <Border.BorderThickness>0</Border.BorderThickness>

                                    <Border.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="{x:Static p:Strings.Button_Launch}"
                                                      Command="{Binding $parent[UserControl].((vm:SearchAreaViewModel)DataContext).PlayCommand, ElementName=Root}"
                                                      CommandParameter="{Binding .}"/>
                                        </ContextMenu>
                                    </Border.ContextMenu>

                                    <Grid>
                                        <!-- Fallback title if no cover is available -->
                                        <TextBlock Text="{Binding Title}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   TextWrapping="Wrap"
                                                   TextAlignment="Center"
                                                   Margin="5"
                                                   IsVisible="{Binding PrimaryCoverPath, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>

                                        <!-- Async image loading for smoother scrolling with large result sets -->
                                        <Image helpers:AsyncImageHelper.Url="{Binding PrimaryCoverPath}"
                                               helpers:AsyncImageHelper.DecodeWidth="300"
                                               Stretch="Uniform"
                                               IsVisible="{Binding PrimaryCoverPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Empty-state message -->
        <TextBlock Grid.Row="1"
                   Text="{x:Static p:Strings.Dialog_NoResult}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   IsVisible="{Binding HasNoResults}"
                   Opacity="0.5"
                   FontSize="16"/>
    </Grid>
</UserControl>
