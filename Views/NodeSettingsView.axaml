<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:Retromind.ViewModels"
        xmlns:models="using:Retromind.Models"
        xmlns:p="clr-namespace:Retromind.Resources"
        xmlns:helpers="using:Retromind.Helpers"
        mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="600"
        x:Class="Retromind.Views.NodeSettingsView"
        x:DataType="vm:NodeSettingsViewModel"
        Title="{x:Static p:Strings.NodeSettings_Title}"
        Width="740" Height="720" MinHeight="480" MaxHeight="900" SizeToContent="Width"
        WindowStartupLocation="CenterOwner"
        CanResize="True">

    <Border Padding="20">
        <!-- Wrap all content in a ScrollViewer to keep the dialog usable
             even with many native wrappers or small screens. -->
        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
            <StackPanel Spacing="20">

                <!-- NAME & DESCRIPTION -->
                <StackPanel Spacing="10">
                    <StackPanel Spacing="5">
                        <TextBlock Text="{x:Static p:Strings.Common_Name}"/>
                        <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"/>
                        <TextBlock Text="{Binding NameValidationMessage}"
                                   FontSize="12"
                                   Foreground="Tomato"
                                   IsVisible="{Binding HasNameValidationMessage}"/>
                        <StackPanel Orientation="Horizontal"
                                    Spacing="6"
                                    IsVisible="{Binding HasNameSuggestion}">
                            <TextBlock Text="{Binding NameSuggestionText}" VerticalAlignment="Center"/>
                            <Button Command="{Binding UseNameSuggestionCommand}"
                                    Content="{x:Static p:Strings.Button_TakeOver}"/>
                        </StackPanel>
                        <TextBlock Text="{Binding SaveErrorMessage}"
                                   FontSize="12"
                                   Foreground="Tomato"
                                   IsVisible="{Binding SaveErrorMessage, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="{x:Static p:Strings.NodeSettings_DescriptionForBigMode}"/>
                        <TextBox Text="{Binding Description}" AcceptsReturn="True" Height="60" TextWrapping="Wrap"/>
                    </StackPanel>
                </StackPanel>

                <!-- NODE ARTWORK (Logo / Wallpaper / Video) -->
                <Expander Header="BigMode Artwork (per category)"
                          IsExpanded="False"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Stretch">
                    <Border BorderBrush="#444444"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="6"
                            Background="#11000000"
                            HorizontalAlignment="Stretch"
                            Margin="0,6,0,0">
                        <StackPanel Spacing="6">

                        <!-- Logo -->
                        <StackPanel Spacing="2">
                            <!-- Row 1: Label + Buttons + Preview -->
                            <Grid ColumnDefinitions="Auto, Auto, Auto, *" ColumnSpacing="6">
                                <TextBlock Grid.Column="0"
                                           Text="Logo"
                                           VerticalAlignment="Center" />

                                <Button Grid.Column="1"
                                        Content="Browse..."
                                        Padding="8,2"
                                        Click="OnBrowseLogoClicked" />

                                <Button Grid.Column="2"
                                        Content="✕"
                                        Padding="6,2"
                                        ToolTip.Tip="Remove logo"
                                        Foreground="Red"
                                        IsEnabled="{Binding NodeLogoPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"
                                        Click="OnClearLogoClicked" />

                                <Border Grid.Column="3"
                                        HorizontalAlignment="Right"
                                        Width="80" Height="40"
                                        Background="#22000000"
                                        CornerRadius="4"
                                        ClipToBounds="True"
                                        VerticalAlignment="Center">
                                    <Image helpers:AsyncImageHelper.Url="{Binding NodeLogoPreviewPath}"
                                           Stretch="Uniform"
                                           IsVisible="{Binding NodeLogoPreviewPath,
                                                               Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}" />
                                </Border>
                            </Grid>

                            <!-- Row 2: Path -->
                            <TextBox Text="{Binding NodeLogoPath}"
                                     IsReadOnly="True"
                                     Background="#22000000"
                                     BorderThickness="0"
                                     Padding="4,2" />

                            <CheckBox Content="Use as fallback for items"
                                      IsChecked="{Binding NodeLogoFallbackEnabled}" />
                        </StackPanel>

                        <!-- Wallpaper -->
                        <StackPanel Spacing="2">
                            <!-- Row 1: Label + Buttons + Preview -->
                            <Grid ColumnDefinitions="Auto, Auto, Auto, *" ColumnSpacing="6">
                                <TextBlock Grid.Column="0"
                                           Text="Wallpaper"
                                           VerticalAlignment="Center" />

                                <Button Grid.Column="1"
                                        Content="Browse..."
                                        Padding="8,2"
                                        Click="OnBrowseWallpaperClicked" />

                                <Button Grid.Column="2"
                                        Content="✕"
                                        Padding="6,2"
                                        ToolTip.Tip="Remove wallpaper"
                                        Foreground="Red"
                                        IsEnabled="{Binding NodeWallpaperPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"
                                        Click="OnClearWallpaperClicked" />

                                <Border Grid.Column="3"
                                        HorizontalAlignment="Right"
                                        Width="120" Height="50"
                                        Background="#22000000"
                                        CornerRadius="4"
                                        ClipToBounds="True"
                                        VerticalAlignment="Center">
                                    <Image helpers:AsyncImageHelper.Url="{Binding NodeWallpaperPreviewPath}"
                                           Stretch="UniformToFill"
                                           IsVisible="{Binding NodeWallpaperPreviewPath,
                                                               Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}" />
                                </Border>
                            </Grid>

                            <!-- Row 2: Path -->
                            <TextBox Text="{Binding NodeWallpaperPath}"
                                     IsReadOnly="True"
                                     Background="#22000000"
                                     BorderThickness="0"
                                     Padding="4,2" />

                            <CheckBox Content="Use as fallback for items"
                                      IsChecked="{Binding NodeWallpaperFallbackEnabled}" />
                        </StackPanel>

                        <!-- Video -->
                        <StackPanel Spacing="2">
                            <!-- Row 1: Label + Buttons -->
                            <Grid ColumnDefinitions="Auto, Auto, Auto, *" ColumnSpacing="6">
                                <TextBlock Grid.Column="0"
                                           Text="Video"
                                           VerticalAlignment="Center" />

                                <Button Grid.Column="1"
                                        Content="Browse..."
                                        Padding="8,2"
                                        Click="OnBrowseVideoClicked" />

                                <Button Grid.Column="2"
                                        Content="✕"
                                        Padding="6,2"
                                        ToolTip.Tip="Remove video"
                                        Foreground="Red"
                                        IsEnabled="{Binding NodeVideoPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"
                                        Click="OnClearVideoClicked" />
                                <!-- Column 3 left empty to align with logo/wallpaper layout -->
                            </Grid>

                            <!-- Row 2: Path -->
                            <TextBox Text="{Binding NodeVideoPath}"
                                     IsReadOnly="True"
                                     Background="#22000000"
                                     BorderThickness="0"
                                     Padding="4,2" />

                            <TextBlock Text="(Preview is currently not shown in this dialog)"
                                       FontSize="11"
                                       Foreground="#888888" />

                            <CheckBox Content="Use as fallback for items"
                                      IsChecked="{Binding NodeVideoFallbackEnabled}" />
                        </StackPanel>

                        <!-- Marquee -->
                        <StackPanel Spacing="2">
                            <!-- Row 1: Label + Buttons + Preview -->
                            <Grid ColumnDefinitions="Auto, Auto, Auto, *" ColumnSpacing="6">
                                <TextBlock Grid.Column="0"
                                           Text="Marquee"
                                           VerticalAlignment="Center" />

                                <Button Grid.Column="1"
                                        Content="Browse..."
                                        Padding="8,2"
                                        Click="OnBrowseMarqueeClicked" />

                                <Button Grid.Column="2"
                                        Content="✕"
                                        Padding="6,2"
                                        ToolTip.Tip="Remove marquee"
                                        Foreground="Red"
                                        IsEnabled="{Binding NodeMarqueePath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"
                                        Click="OnClearMarqueeClicked" />

                                <Border Grid.Column="3"
                                        HorizontalAlignment="Right"
                                        Width="120" Height="50"
                                        Background="#22000000"
                                        CornerRadius="4"
                                        ClipToBounds="True"
                                        VerticalAlignment="Center">
                                    <Image helpers:AsyncImageHelper.Url="{Binding NodeMarqueePreviewPath}"
                                           Stretch="Uniform"
                                           IsVisible="{Binding NodeMarqueePreviewPath,
                                                               Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}" />
                                </Border>
                            </Grid>

                            <!-- Row 2: Path -->
                            <TextBox Text="{Binding NodeMarqueePath}"
                                     IsReadOnly="True"
                                     Background="#22000000"
                                     BorderThickness="0"
                                     Padding="4,2" />

                            <CheckBox Content="Use as fallback for items"
                                      IsChecked="{Binding NodeMarqueeFallbackEnabled}" />
                        </StackPanel>
                        </StackPanel>
                    </Border>
                </Expander>

                <!-- EMULATOR -->
                <StackPanel Spacing="5">
                    <TextBlock Text="{x:Static p:Strings.NodeSettings_DefaultEmulatorForFolder}"/>
                    <ComboBox ItemsSource="{Binding AvailableEmulators}"
                              SelectedItem="{Binding SelectedEmulator}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock Text="{Binding InheritedEmulatorInfo}"
                               IsVisible="{Binding IsEmulatorInherited}"
                               FontSize="11"
                               Foreground="#888888" />
                </StackPanel>

                <!-- Native wrapper chain (Linux) -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Native Wrapper (Linux)" FontWeight="Bold" />

                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <RadioButton Content="Inherit"
                                     IsChecked="{Binding IsNativeWrapperInherit, Mode=TwoWay}" />
                        <RadioButton Content="None"
                                     IsChecked="{Binding IsNativeWrapperNone, Mode=TwoWay}" />
                        <RadioButton Content="Override"
                                     IsChecked="{Binding IsNativeWrapperOverride, Mode=TwoWay}" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="{Binding InheritedWrappersInfo}"
                                   FontSize="11"
                                   Foreground="#888888" />
                        <ItemsControl ItemsSource="{Binding InheritedWrappers}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto, 8, *" Margin="0,2,0,0">
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding Path}"
                                                   FontSize="11"
                                                   Foreground="#888888" />
                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding Args}"
                                                   FontSize="11"
                                                   Foreground="#888888" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <StackPanel IsVisible="{Binding IsNativeWrapperOverride}">
                        <Button Content="+ Add wrapper"
                                Command="{Binding AddNativeWrapperCommand}"
                                HorizontalAlignment="Left" />

                        <ItemsControl ItemsSource="{Binding NativeWrappers}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#10000000" CornerRadius="4" Padding="8" Margin="0,5,0,0">
                                        <Grid ColumnDefinitions="*, 10, *, 10, Auto" RowDefinitions="Auto, Auto" >
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Path" />
                                            <TextBlock Grid.Row="0" Grid.Column="2" Text="Args" />

                                            <TextBox Grid.Row="1" Grid.Column="0"
                                                     Text="{Binding Path, Mode=TwoWay}"
                                                     Watermark="gamemoderun / mangohud / env" />

                                            <TextBox Grid.Row="1" Grid.Column="2"
                                                     Text="{Binding Args, Mode=TwoWay}" />

                                            <StackPanel Grid.Row="1" Grid.Column="4" Orientation="Horizontal" Spacing="5">
                                                <Button Content="↑"
                                                        ToolTip.Tip="Move up"
                                                        Command="{Binding $parent[Window].((vm:NodeSettingsViewModel)DataContext).MoveNativeWrapperUpCommand}"
                                                        CommandParameter="{Binding}" />
                                                <Button Content="↓"
                                                        ToolTip.Tip="Move down"
                                                        Command="{Binding $parent[Window].((vm:NodeSettingsViewModel)DataContext).MoveNativeWrapperDownCommand}"
                                                        CommandParameter="{Binding}" />
                                                <Button Content="✕"
                                                        Command="{Binding $parent[Window].((vm:NodeSettingsViewModel)DataContext).RemoveNativeWrapperCommand}"
                                                        CommandParameter="{Binding .}" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>

                <!-- Node-level environment variables -->
                <StackPanel Spacing="8">
                    <TextBlock Text="{x:Static p:Strings.NodeSettings_EnvOverridesTitle}" FontWeight="Bold" />

                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <RadioButton Content="Inherit"
                                     IsChecked="{Binding IsEnvironmentOverrideInherit, Mode=TwoWay}" />
                        <RadioButton Content="None"
                                     IsChecked="{Binding IsEnvironmentOverrideNone, Mode=TwoWay}" />
                        <RadioButton Content="Override"
                                     IsChecked="{Binding IsEnvironmentOverrideOverride, Mode=TwoWay}" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="{Binding InheritedEnvironmentOverridesInfo}"
                                   FontSize="11"
                                   Foreground="#888888" />
                        <ItemsControl ItemsSource="{Binding InheritedEnvironmentOverrides}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto, 8, *" Margin="0,2,0,0">
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding Key}"
                                                   FontSize="11"
                                                   Foreground="#888888" />
                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding Value}"
                                                   FontSize="11"
                                                   Foreground="#888888" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <StackPanel IsVisible="{Binding IsEnvironmentOverrideOverride}">
                        <Button Content="+ Add variable"
                                Command="{Binding AddEnvironmentOverrideCommand}"
                                HorizontalAlignment="Left" />

                        <ItemsControl ItemsSource="{Binding EnvironmentOverrides}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#10000000" CornerRadius="4" Padding="8" Margin="0,5,0,0">
                                        <Grid ColumnDefinitions="*, 10, *, 10, Auto" RowDefinitions="Auto, Auto">
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Key" />
                                            <TextBlock Grid.Row="0" Grid.Column="2" Text="Value" />

                                            <TextBox Grid.Row="1" Grid.Column="0"
                                                     Text="{Binding Key, Mode=TwoWay}"
                                                     Watermark="PROTONPATH" />

                                            <TextBox Grid.Row="1" Grid.Column="2"
                                                     Text="{Binding Value, Mode=TwoWay}" />

                                            <Button Grid.Row="1" Grid.Column="4" Content="✕"
                                                    Command="{Binding $parent[Window].((vm:NodeSettingsViewModel)DataContext).RemoveEnvironmentOverrideCommand}"
                                                    CommandParameter="{Binding .}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            
                <!-- BIGMODE THEME -->
                <StackPanel Spacing="5">
                    <TextBlock Text="{x:Static p:Strings.NodeSettings_BigModeThemeHint}"/>
                    <ComboBox ItemsSource="{Binding AvailableThemes}"
                              SelectedItem="{Binding SelectedTheme}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={x:Static helpers:StringConverters.ThemePathToFolderName}}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <Button Content="{x:Static p:Strings.NodeSettings_ThemeAuto}"
                            HorizontalAlignment="Left"
                            Command="{Binding ClearThemeCommand}"
                            IsVisible="{Binding IsThemeExplicitlySelected}"/>
                
                    <TextBlock Text="System-Theme (System-Auswahl)"
                               FontWeight="SemiBold"
                               Margin="0,8,0,2" />

                    <ComboBox ItemsSource="{Binding AvailableSystemThemes}"
                              SelectedItem="{Binding SelectedSystemTheme}"
                              Width="260"
                              IsEnabled="{Binding IsSystemThemeSelectionEnabled}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="helpers:SystemThemeOption">
                                <TextBlock Text="{Binding DisplayName}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!-- OPTIONS -->
                <StackPanel Spacing="10">
                    <CheckBox Content="{x:Static p:Strings.NodeSettings_RandomizeCovers}"
                              IsChecked="{Binding RandomizeCovers}"
                              IsThreeState="True"
                              ToolTip.Tip="{x:Static p:Strings.NodeSettings_RandomizeCoversHint}"/>
                    <CheckBox Content="{x:Static p:Strings.NodeSettings_RandomizeMusic}"
                              IsChecked="{Binding RandomizeMusic}"
                              IsThreeState="True"
                              ToolTip.Tip="{x:Static p:Strings.NodeSettings_RandomizeMusicHint}"/>
                </StackPanel>

                <!-- BUTTONS -->
                <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right" Margin="0,10,0,0">
                    <Button Content="{x:Static p:Strings.Button_Cancel}" Command="{Binding CancelCommand}"/>
                    <Button Content="{x:Static p:Strings.Button_Save}" Classes="accent" Command="{Binding SaveCommand}"/>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Border>
</Window>
