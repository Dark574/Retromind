<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Retromind.ViewModels"
        xmlns:p="clr-namespace:Retromind.Resources"
        xmlns:models="clr-namespace:Retromind.Models"
        x:Class="Retromind.Views.SettingsView"
        x:DataType="vm:SettingsViewModel"
        Title="{x:Static p:Strings.Settings_Title}"
        Width="750" Height="550"
        WindowStartupLocation="CenterOwner">

    <Grid RowDefinitions="Auto, *, Auto" Margin="20">

        <!-- Header Hint -->
        <StackPanel Grid.Row="0" Orientation="Vertical" Spacing="5" Margin="0,0,0,15">
            <TextBlock Text="{x:Static p:Strings.Settings_GlobalSettingsHint}"
                       Opacity="0.6" FontStyle="Italic" />

            <StackPanel Orientation="Horizontal" Spacing="10">
                <CheckBox IsChecked="{Binding PreferPortableLaunchPaths}"
                          Content="Store launch file paths relative to Retromind data folder (portable)" />

                <Button Content="Convert existing launch paths"
                        Command="{Binding ConvertExistingToPortableCommand}" />
            </StackPanel>
            <StackPanel Orientation="Vertical" Spacing="4">

                <!-- Toggle: auto-play music on selection in main grid -->
                <CheckBox Content="Play random music"
                          IsChecked="{Binding EnableSelectionMusicPreview}"
                          ToolTip.Tip="When enabled, selecting an item in the main grid automatically plays its music asset (if available)." />
            </StackPanel>
        </StackPanel>
        
        <!-- Main Content with Tabs -->
        <TabControl Grid.Row="1">
            
            <!-- TAB 1: EMULATORS -->
            <TabItem Header="{x:Static p:Strings.Settings_TabEmulators}">
                <Grid ColumnDefinitions="200, 20, *">
                    <!-- LEFT: List of emulators -->
                    <Grid Grid.Column="0" RowDefinitions="*, Auto">
                        <ListBox Grid.Row="0"
                                 ItemsSource="{Binding Emulators}"
                                 SelectedItem="{Binding SelectedEmulator}">
                            <ListBox.ItemTemplate>
                                <DataTemplate  x:DataType="models:EmulatorConfig">
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="0,10,0,0">
                            <Button Content="+" Command="{Binding AddEmulatorCommand}" ToolTip.Tip="{x:Static p:Strings.Button_Add}" />
                            <Button Content="-" Command="{Binding RemoveEmulatorCommand}" ToolTip.Tip="{x:Static p:Strings.Button_Remove}" />
                        </StackPanel>
                    </Grid>

                    <!-- RIGHT: Emulator Details -->
                    <ScrollViewer Grid.Column="2">
                        <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="5" Padding="15"
                                IsVisible="{Binding SelectedEmulator, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <StackPanel Spacing="15" DataContext="{Binding SelectedEmulator}">
                                <TextBlock Text="{x:Static p:Strings.Settings_SectionEmulators}" FontWeight="Bold" FontSize="16" Margin="0,0,0,10" />

                                <!-- Name -->
                                <StackPanel>
                                    <TextBlock Text="{x:Static p:Strings.Settings_ProfileName}" FontWeight="Bold" />
                                    <TextBox Text="{Binding Name}" />
                                </StackPanel>

                                <!-- Path -->
                                <StackPanel>
                                    <TextBlock Text="{x:Static p:Strings.Settings_ExecutablePath}" FontWeight="Bold" />
                                    <Grid ColumnDefinitions="*, Auto">
                                        <TextBox Grid.Column="0" Text="{Binding Path}" />
                                        <Button Grid.Column="1" Content="..."
                                                ToolTip.Tip="{x:Static p:Strings.Button_Browse}"
                                                Command="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).BrowsePathCommand}" Margin="5,0,0,0" />
                                    </Grid>
                                </StackPanel>

                                <!-- Arguments -->
                                <StackPanel>
                                    <TextBlock Text="{x:Static p:Strings.Settings_DefaultArguments}" FontWeight="Bold" />
                                    <TextBox Text="{Binding Arguments}" />
                                </StackPanel>

                                <!-- Advanced: Wine/Proton/UMU prefix -->
                                <Expander Header="{x:Static p:Strings.Settings_Advanced}" IsExpanded="False">
                                    <StackPanel Spacing="8">
                                        <CheckBox Content="{x:Static p:Strings.Settings_UseWinePrefix}"
                                                  IsChecked="{Binding UsesWinePrefix}"
                                                  ToolTip.Tip="{x:Static p:Strings.Settings_UseWinePrefix_Hint}" />

                                        <CheckBox Content="{x:Static p:Strings.Settings_UsePlaylistForMultiDisc}"
                                                  IsChecked="{Binding UsePlaylistForMultiDisc}"
                                                  ToolTip.Tip="{x:Static p:Strings.Settings_UsePlaylistForMultiDisc_Hint}" />
                                    </StackPanel>
                                </Expander>
                                
                                <!-- Native wrapper chain (Linux, emulator-level) -->
                                <StackPanel Spacing="8" Margin="0,10,0,0"
                                            DataContext="{Binding $parent[Window].((vm:SettingsViewModel)DataContext)}">
                                    <TextBlock Text="Native Wrapper (Linux)" FontWeight="Bold" />

                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <RadioButton Content="Inherit"
                                                     IsChecked="{Binding IsNativeWrapperInherit, Mode=TwoWay}" />
                                        <RadioButton Content="None"
                                                     IsChecked="{Binding IsNativeWrapperNone, Mode=TwoWay}" />
                                        <RadioButton Content="Override"
                                                     IsChecked="{Binding IsNativeWrapperOverride, Mode=TwoWay}" />
                                    </StackPanel>

                                    <StackPanel IsVisible="{Binding IsNativeWrapperOverride}">
                                        <Button Content="+ Add wrapper"
                                                Command="{Binding AddEmulatorWrapperCommand}"
                                                HorizontalAlignment="Left" />

                                        <ItemsControl ItemsSource="{Binding EmulatorNativeWrappers}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#10000000" CornerRadius="4" Padding="8" Margin="0,5,0,0">
                                                        <Grid ColumnDefinitions="*, 10, *, 10, Auto" RowDefinitions="Auto, Auto" >
                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Path" />
                                                            <TextBlock Grid.Row="0" Grid.Column="2" Text="Args" />

                                                            <TextBox Grid.Row="1" Grid.Column="0"
                                                                     Text="{Binding Path, Mode=TwoWay}"
                                                                     Watermark="gamemoderun / mangohud / env" />

                                                            <TextBox Grid.Row="1" Grid.Column="2"
                                                                     Text="{Binding Args, Mode=TwoWay}" />

                                                            <StackPanel Grid.Row="1" Grid.Column="4" Orientation="Horizontal" Spacing="5">
                                                                <Button Content="↑"
                                                                        ToolTip.Tip="Move up"
                                                                        Command="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).MoveEmulatorWrapperUpCommand}"
                                                                        CommandParameter="{Binding}" />
                                                                <Button Content="↓"
                                                                        ToolTip.Tip="Move down"
                                                                        Command="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).MoveEmulatorWrapperDownCommand}"
                                                                        CommandParameter="{Binding}" />
                                                                <Button Content="✕"
                                                                        Command="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).RemoveEmulatorWrapperCommand}"
                                                                        CommandParameter="{Binding .}" />
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- Emulator-level environment variables -->
                                <StackPanel Spacing="8" Margin="0,10,0,0"
                                            DataContext="{Binding $parent[Window].((vm:SettingsViewModel)DataContext)}">
                                    <TextBlock Text="Environment Variables (emulator)" FontWeight="Bold" />

                                    <Button Content="+ Add variable"
                                            Command="{Binding AddEmulatorEnvVarCommand}"
                                            HorizontalAlignment="Left" />

                                    <ItemsControl ItemsSource="{Binding EmulatorEnvironmentOverrides}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid ColumnDefinitions="*, 10, * , Auto" Margin="0,5,0,0">
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="Key" />
                                                        <TextBox Text="{Binding Key, Mode=TwoWay}"
                                                                 Watermark="e.g. PROTONPATH" />
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="2">
                                                        <TextBlock Text="Value" />
                                                        <TextBox Text="{Binding Value, Mode=TwoWay}"
                                                                 Watermark="/path/to/proton" />
                                                    </StackPanel>
                                                    <Button Grid.Column="3"
                                                            Content="✕"
                                                            Margin="5,18,0,0"
                                                            Command="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).RemoveEmulatorEnvVarCommand}"
                                                            CommandParameter="{Binding .}" />
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </ScrollViewer>
                </Grid>
            </TabItem>
            
            <!-- TAB 2: METADATA (SCRAPER) -->
            <TabItem Header="{x:Static p:Strings.Settings_TabMetadata}">
                <Grid ColumnDefinitions="200, 20, *">
                    <!-- LEFT: List of scrapers -->
                    <Grid Grid.Column="0" RowDefinitions="*, Auto">
                        <ListBox Grid.Row="0"
                                 ItemsSource="{Binding Scrapers}"
                                 SelectedItem="{Binding SelectedScraper}">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="0,10,0,0">
                            <Button Content="+" Command="{Binding AddScraperCommand}" ToolTip.Tip="{x:Static p:Strings.Button_Add}" />
                            <Button Content="-" Command="{Binding RemoveScraperCommand}" ToolTip.Tip="{x:Static p:Strings.Button_Remove}" />
                        </StackPanel>
                    </Grid>
                    
                    <!-- RIGHT: Scraper Details -->
                    <ScrollViewer Grid.Column="2"> 
                        <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="5" Padding="15"
                                IsVisible="{Binding SelectedScraper, Converter={x:Static ObjectConverters.IsNotNull}}">
    
                            <StackPanel Spacing="15" DataContext="{Binding SelectedScraper}">
                                <TextBlock Text="{x:Static p:Strings.Dialog_ConfigureMetadata}" FontWeight="Bold" FontSize="16"
                                           Margin="0,0,0,10" />
    
                                <!-- Name -->
                                <StackPanel>
                                    <TextBlock Text="{x:Static p:Strings.Metadata_Designation}" FontWeight="Bold" />
                                    <TextBox Text="{Binding Name}" />
                                </StackPanel>
                                
                                <!-- Type -->
                                <StackPanel>
                                    <TextBlock Text="{x:Static p:Strings.Metadata_Type}" FontWeight="Bold" />
                                    <ComboBox ItemsSource="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).AvailableScraperTypes}"
                                              SelectedItem="{Binding Type}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                                
                                <Separator Height="1" Background="Gray" Opacity="0.5" Margin="0,10"/>
                                
                                <TextBlock Text="{x:Static p:Strings.Metadata_AccessData}" FontWeight="Bold" FontSize="14" Margin="0,5,0,0"/>
    
                                <!-- IGDB Fields -->
                                <StackPanel IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsIgdbSelected}">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{x:Static p:Strings.Metadata_Client}" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.Hint_IgdbCredentials}" FontSize="10" Opacity="0.6" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding ClientId}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,10,0,0">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{x:Static p:Strings.Metadata_ClientSecret}" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.Hint_IgdbCredentials}" FontSize="10" Opacity="0.6" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding ClientSecret}" PasswordChar="*" />
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- Login Fields (EmuMovies) -->
                                <StackPanel IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsEmuMoviesSelected}">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{x:Static p:Strings.Common_UserName}" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.Hint_Required}" FontSize="10" Foreground="Red" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding Username}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,10,0,0">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{x:Static p:Strings.Common_Password}" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.Hint_Required}" FontSize="10" Foreground="Red" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding Password}" PasswordChar="*" />
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- API Key (TMDB & Others) -->
                                <StackPanel>
                                    <StackPanel.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="!$parent[Window].((vm:SettingsViewModel)DataContext).IsIgdbSelected"/>
                                            <Binding Path="!$parent[Window].((vm:SettingsViewModel)DataContext).IsEmuMoviesSelected"/>
                                        </MultiBinding>
                                    </StackPanel.IsVisible>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{x:Static p:Strings.Metadata_ApiKey}" FontWeight="Bold" />
                                        <TextBlock Text="{x:Static p:Strings.Hint_TmdbKey}" 
                                                   IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsTmdbSelected}"
                                                   FontSize="10" Opacity="0.6" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                    </StackPanel>
                                    <TextBox Text="{Binding ApiKey}" PasswordChar="*" />
                                </StackPanel>

                                <!-- Language (Specific to TMDB) -->
                                <StackPanel IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsTmdbSelected}">
                                    <TextBlock Text="{x:Static p:Strings.Metadata_DataLanguage}" FontWeight="Bold" Margin="0,10,0,2"/>
                                    <ComboBox SelectedItem="{Binding Language}" HorizontalAlignment="Stretch">
                                        <ComboBox.Items>
                                            <x:String>de-DE</x:String>
                                            <x:String>en-US</x:String>
                                        </ComboBox.Items>
                                    </ComboBox>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </ScrollViewer>
                    
                     <!-- Fallback when no scraper selected -->
                    <TextBlock Grid.Column="2"
                               Text="{x:Static p:Strings.Dialog_ChooseASource}"
                               VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5"
                               IsVisible="{Binding SelectedScraper, Converter={x:Static ObjectConverters.IsNull}}" />
                </Grid>
            </TabItem>
            
        </TabControl>

        <!-- Footer Buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,20,0,0">
            <Button Content="{x:Static p:Strings.Button_Save}" Command="{Binding SaveCommand}" Classes="accent"
                    IsDefault="True" />
        </StackPanel>
    </Grid>
</Window>