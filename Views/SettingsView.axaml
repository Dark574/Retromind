<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Retromind.ViewModels"
        xmlns:p="clr-namespace:Retromind.Resources"
        xmlns:models="clr-namespace:Retromind.Models"
        x:Class="Retromind.Views.SettingsView"
        x:DataType="vm:SettingsViewModel"
        Title="{x:Static p:Strings.SettingsTitle}"
        Width="750" Height="550"
        WindowStartupLocation="CenterOwner">

    <Grid RowDefinitions="Auto, *, Auto" Margin="20">

        <!-- Header Hinweis -->
        <TextBlock Grid.Row="0" Text="{x:Static p:Strings.GlobalSettingsHint}"
                   Margin="0,0,0,15" Opacity="0.6" FontStyle="Italic" />

        <!-- Hauptbereich mit Tabs -->
        <TabControl Grid.Row="1">
            
            <!-- TAB 1: EMULATOREN -->
            <TabItem Header="{x:Static p:Strings.TabEmulators}">
                <Grid ColumnDefinitions="200, 20, *">
                    <!-- LINKS: Liste der Emulatoren -->
                    <Grid Grid.Column="0" RowDefinitions="*, Auto">
                        <ListBox Grid.Row="0"
                                 ItemsSource="{Binding Emulators}"
                                 SelectedItem="{Binding SelectedEmulator}">
                            <ListBox.ItemTemplate>
                                <DataTemplate  x:DataType="models:EmulatorConfig">
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="0,10,0,0">
                            <Button Content="+" Command="{Binding AddEmulatorCommand}" />
                            <Button Content="-" Command="{Binding RemoveEmulatorCommand}" />
                        </StackPanel>
                    </Grid>

                    <!-- RECHTS: Details Scraper -->
                    <Border Grid.Column="2" BorderBrush="Gray" BorderThickness="1" CornerRadius="5" Padding="15"
                            IsVisible="{Binding SelectedEmulator, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <!-- ... Details Emulatoren ... -->
                        <StackPanel Spacing="15" DataContext="{Binding SelectedEmulator}">
                            <TextBlock Text="{x:Static p:Strings.SectionEmulators}" FontWeight="Bold" FontSize="16" Margin="0,0,0,10" />
                            <!-- Name -->
                            <StackPanel>
                                <TextBlock Text="{x:Static p:Strings.ProfileName}" FontWeight="Bold" />
                                <TextBox Text="{Binding Name}" />
                            </StackPanel>
                            <!-- Typ -->
                            <StackPanel>
                                <TextBlock Text="{x:Static p:Strings.ExecutablePath}" FontWeight="Bold" />
                                <Grid ColumnDefinitions="*, Auto">
                                    <TextBox Grid.Column="0" Text="{Binding Path}" />
                                    <Button Grid.Column="1" Content="..." Command="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).BrowsePathCommand}" Margin="5,0,0,0" />
                                </Grid>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="{x:Static p:Strings.DefaultArguments}" FontWeight="Bold" />
                                <TextBox Text="{Binding Arguments}" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>
            
            <!-- TAB 2: METADATEN (SCRAPER) -->
            <TabItem Header="{x:Static p:Strings.TabMetadata}">
                <Grid ColumnDefinitions="200, 20, *">
                    <!-- LINKS: Liste der Scraper -->
                    <Grid Grid.Column="0" RowDefinitions="*, Auto">
                        <ListBox Grid.Row="0"
                                 ItemsSource="{Binding Scrapers}"
                                 SelectedItem="{Binding SelectedScraper}">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="0,10,0,0">
                            <Button Content="+" Command="{Binding AddScraperCommand}" />
                            <Button Content="-" Command="{Binding RemoveScraperCommand}" />
                        </StackPanel>
                    </Grid>
                    
                    <!-- RECHTS: Details Scraper -->
                    <ScrollViewer Grid.Column="2"> 
                        <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="5" Padding="15"
                                IsVisible="{Binding SelectedScraper, Converter={x:Static ObjectConverters.IsNotNull}}">
    
                            <StackPanel Spacing="15" DataContext="{Binding SelectedScraper}">
                                <TextBlock Text="Metadaten konfigurieren" FontWeight="Bold" FontSize="16"
                                           Margin="0,0,0,10" />
    
                                <!-- Name -->
                                <StackPanel>
                                    <TextBlock Text="Bezeichnung" FontWeight="Bold" />
                                    <TextBox Text="{Binding Name}" />
                                </StackPanel>
                                
                                <!-- Typ -->
                                <StackPanel>
                                    <TextBlock Text="Typ / Dienst" FontWeight="Bold" />
                                    <ComboBox ItemsSource="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).AvailableScraperTypes}"
                                              SelectedItem="{Binding Type}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                                
                                <Separator Height="1" Background="Gray" Opacity="0.5" Margin="0,10"/>
                                
                                <TextBlock Text="Zugangsdaten" FontWeight="Bold" FontSize="14" Margin="0,5,0,0"/>
    
                                <!-- IGDB Felder -->
                                <StackPanel IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsIgdbSelected}">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Client ID" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.HintIgdbCredentials}" FontSize="10" Opacity="0.6" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding ClientId}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,10,0,0">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Client Secret" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.HintIgdbCredentials}" FontSize="10" Opacity="0.6" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding ClientSecret}" PasswordChar="*" />
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- Login Felder -->
                                <StackPanel IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsEmuMoviesSelected}">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Benutzername" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.HintRequired}" FontSize="10" Foreground="Red" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding Username}" />
                                    </StackPanel>
                                    <StackPanel Margin="0,10,0,0">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Passwort" FontWeight="Bold" />
                                            <TextBlock Text="{x:Static p:Strings.HintRequired}" FontSize="10" Foreground="Red" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                        </StackPanel>
                                        <TextBox Text="{Binding Password}" PasswordChar="*" />
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- API Key (TMDB & Andere) -->
                                <!-- Sichtbar wenn NICHT IGDB und NICHT EmuMovies -->
                                <StackPanel>
                                    <!-- Visibility Trick: Wenn TMDB, dann zeigen. Bei anderen (GoogleBooks) auch. -->
                                    <!-- Einfachheitshalber zeigen wir es immer, außer bei EmuMovies/IGDB die keine API Keys nutzen in diesem Feld -->
                                    <StackPanel.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="!$parent[Window].((vm:SettingsViewModel)DataContext).IsIgdbSelected"/>
                                            <Binding Path="!$parent[Window].((vm:SettingsViewModel)DataContext).IsEmuMoviesSelected"/>
                                        </MultiBinding>
                                    </StackPanel.IsVisible>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="API Key" FontWeight="Bold" />
                                        <!-- Spezieller TMDB Hinweis -->
                                        <TextBlock Text="{x:Static p:Strings.HintTmdbKey}" 
                                                   IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsTmdbSelected}"
                                                   FontSize="10" Opacity="0.6" VerticalAlignment="Bottom" Margin="5,0,0,2"/>
                                    </StackPanel>
                                    <TextBox Text="{Binding ApiKey}" PasswordChar="*" />
                                </StackPanel>
                                <!-- Sprache (Nur für TMDB sichtbar) -->
                                <StackPanel IsVisible="{Binding $parent[Window].((vm:SettingsViewModel)DataContext).IsTmdbSelected}">
                                    <TextBlock Text="Daten-Sprache" FontWeight="Bold" Margin="0,10,0,2"/>
                                    <ComboBox SelectedItem="{Binding Language}" HorizontalAlignment="Stretch">
                                        <ComboBox.Items>
                                            <x:String>de-DE</x:String>
                                            <x:String>en-US</x:String>
                                        </ComboBox.Items>
                                    </ComboBox>
                                </StackPanel>
    
                            </StackPanel>
                        </Border>
                    </ScrollViewer>
                    
                     <!-- Fallback -->
                    <TextBlock Grid.Column="2"
                               Text="Wähle eine Quelle aus"
                               VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5"
                               IsVisible="{Binding SelectedScraper, Converter={x:Static ObjectConverters.IsNull}}" />
                </Grid>
            </TabItem>
            
        </TabControl>

        <!-- Buttons unten -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,20,0,0">
            <Button Content="{x:Static p:Strings.Save}" Command="{Binding SaveCommand}" Classes="accent"
                    IsDefault="True" />
        </StackPanel>
    </Grid>
</Window>