<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Retromind.ViewModels"
             xmlns:video="using:Retromind.Helpers.Video"
             xmlns:helpers="using:Retromind.Helpers"
             xmlns:ext="clr-namespace:Retromind.Extensions;assembly=Retromind"
             xmlns:resources="clr-namespace:Retromind.Resources"
             x:DataType="vm:BigModeViewModel"
             x:Name="BigModeRoot"
             Background="Black"

             ext:ThemeProperties.AccentColor="#FFD700"
             ext:ThemeProperties.BackgroundDimOpacity="0.25"
             ext:ThemeProperties.TitleFontSize="48"
             ext:ThemeProperties.BodyFontSize="18"
             ext:ThemeProperties.FadeDurationMs="250"
             ext:ThemeProperties.MoveDurationMs="250"
             ext:ThemeProperties.VideoEnabled="True"
             ext:ThemeProperties.VideoSlotName="VideoSlot"
             ext:ThemeProperties.VideoCornerRadius="8"
             ext:ThemeProperties.VideoBorderThickness="0"
             ext:ThemeProperties.VideoStretchMode="Uniform">

    <UserControl.Styles>
        <!-- ... Styles remain unchanged ... -->
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut"/>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.25" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="ListBoxItem TextBlock">
            <Setter Property="Foreground" Value="#CCCCCC" /> 
        </Style>
        <Style Selector="ListBoxItem:selected TextBlock">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Effect" Value="drop-shadow(0 0 8 #FFD700)" />
        </Style>
        <Style Selector="ListBoxItem:selected > Panel > TextBlock[IsVisible=True]">
             <Setter Property="Foreground" Value="#FFD700" />
        </Style>
        <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
        </Style>
    </UserControl.Styles>
    
    <UserControl.Resources>
        <!-- Playtime formatting -->
        <helpers:TimeSpanToHumanReadableConverter x:Key="TimeConverter" />
    </UserControl.Resources>
    
    <Panel>
        <!-- LAYER 1: Background -->
        <!-- Wallpaper for Games-View -->
        <Image Name="GameWallpaper"
               helpers:AsyncImageHelper.Url="{Binding SelectedItem.PrimaryWallpaperPath}"
               Stretch="UniformToFill"
               IsVisible="{Binding IsGameListActive}"
               Opacity="{Binding ElementName=BigModeRoot, Path=(ext:ThemeProperties.BackgroundDimOpacity)}" />
        
        <!-- Wallpaper for Categories-View -->
        <Image Name="CategoryWallpaper"
               helpers:AsyncImageHelper.Url="{Binding SelectedCategory.PrimaryWallpaperPath}"
               Stretch="UniformToFill"
               IsVisible="{Binding IsCategorySelectionActive}"
               Opacity="{Binding ElementName=BigModeRoot, Path=(ext:ThemeProperties.BackgroundDimOpacity)}" />
        
        <!-- Games-Wheel -->
        <ListBox ItemsSource="{Binding Items}"
                 SelectedItem="{Binding SelectedItem}"
                 IsVisible="{Binding IsGameListActive}"
                 Background="Transparent"
                 AutoScrollToSelectedItem="True"
                 SelectedIndex="{Binding SelectedItemIndex, Mode=OneWayToSource}"
                 ClipToBounds="False"
                 VerticalAlignment="Stretch"
                 HorizontalAlignment="Left"
                 Width="450"
                 ext:ThemeProperties.UseHostSelectionEffects="False">
            
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <helpers:WheelPanel WheelRadius="500" 
                                        ItemSpacingAngle="18"
                                        helpers:WheelPanel.OffsetX="225"
                                        helpers:WheelPanel.SelectedItemIndex="{Binding $parent[ListBox].SelectedIndex}"/>
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>

            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Panel Width="300" Height="140">
                        <Image helpers:AsyncImageHelper.Url="{Binding PrimaryLogoPath}" Stretch="Uniform"
                               IsVisible="{Binding PrimaryLogoPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        <TextBlock Text="{Binding Title}"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding PrimaryLogoPath, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                    </Panel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Categories-Wheel -->
        <ListBox ItemsSource="{Binding CurrentCategories}"
                 SelectedItem="{Binding SelectedCategory}"
                 IsVisible="{Binding IsCategorySelectionActive}"
                 Background="Transparent"
                 AutoScrollToSelectedItem="True"
                 ClipToBounds="False"
                 VerticalAlignment="Stretch"
                 HorizontalAlignment="Left"
                 Width="450"
                 ext:ThemeProperties.UseHostSelectionEffects="False">
            
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <helpers:WheelPanel WheelRadius="500" 
                                        ItemSpacingAngle="18"
                                        helpers:WheelPanel.OffsetX="225"
                                        helpers:WheelPanel.SelectedItemIndex="{Binding $parent[ListBox].SelectedIndex}"/>
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>

            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Panel Width="300" Height="140">
                        <!-- Categorie-Logo, if available -->
                        <Image helpers:AsyncImageHelper.Url="{Binding PrimaryLogoPath}" Stretch="Uniform"
                               IsVisible="{Binding PrimaryLogoPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        
                        <!-- Fallback: Categorie name -->
                        <TextBlock Text="{Binding Name}"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding PrimaryLogoPath, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                    </Panel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        
        <!-- LAYER 3: The right-hand content -->
        <Grid ColumnDefinitions="*" RowDefinitions="*, Auto" Margin="450,0,0,0">
            <!-- METADATA in a semi-transparent panel (similar to Default outer frame) -->
            <Border Grid.Row="0"
                    Margin="40,60,60,10"
                    Background="#CC181A20"
                    CornerRadius="8"
                    Padding="16">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              VerticalAlignment="Stretch">
                    <StackPanel>
                        <!-- Category title & description -->
                        <StackPanel IsVisible="{Binding IsCategorySelectionActive}"
                                    Spacing="12">
                            <TextBlock Text="{Binding SelectedCategory.Name}"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       FontSize="36"
                                       TextWrapping="Wrap"/>
                            <TextBlock Text="{Binding SelectedCategory.Description}"
                                       Foreground="#DDFFFFFF"
                                       TextWrapping="Wrap"/>
                        </StackPanel>

                        <!-- Game title & description -->
                        <StackPanel IsVisible="{Binding IsGameListActive}"
                                    Spacing="12">
                            <TextBlock Text="{Binding SelectedItem.Title}"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       FontSize="36"
                                       TextWrapping="Wrap"/>
                            <TextBlock Text="{Binding SelectedItem.Description}"
                                       Foreground="#DDFFFFFF"
                                       TextWrapping="Wrap"/>
                        </StackPanel>

                        <!-- Additional game details (only in game mode) -->
                        <Grid Margin="0,20,0,0"
                              RowDefinitions="Auto,Auto,Auto"
                              ColumnDefinitions="*,*"
                              ColumnSpacing="16"
                              RowSpacing="10"
                              IsVisible="{Binding IsGameListActive}">
                            <!-- Release date -->
                            <StackPanel Grid.Row="0" Grid.Column="0" Spacing="4">
                                <TextBlock Text="{x:Static resources:Strings.Common_ReleaseDate}"
                                           Foreground="#7BA3FF"
                                           FontWeight="SemiBold"
                                           FontSize="14" />
                                <TextBlock Text="{Binding SelectedItem.ReleaseDate, StringFormat={}{0:yyyy-MM-dd}}"
                                           Foreground="White" />
                            </StackPanel>

                            <!-- Developer -->
                            <StackPanel Grid.Row="0" Grid.Column="1" Spacing="4">
                                <TextBlock Text="{x:Static resources:Strings.Common_Developer}"
                                           Foreground="#7BA3FF"
                                           FontWeight="SemiBold"
                                           FontSize="14" />
                                <TextBlock Text="{Binding SelectedDeveloper}"
                                           Foreground="White"
                                           TextTrimming="CharacterEllipsis" />
                            </StackPanel>

                            <!-- Play count -->
                            <StackPanel Grid.Row="1" Grid.Column="0" Spacing="4">
                                <TextBlock Text="{x:Static resources:Strings.Media_PlayCount}"
                                           Foreground="#7BA3FF"
                                           FontWeight="SemiBold"
                                           FontSize="14" />
                                <TextBlock Text="{Binding SelectedItem.PlayCount}"
                                           Foreground="White" />
                            </StackPanel>

                            <!-- Last played -->
                            <StackPanel Grid.Row="1" Grid.Column="1" Spacing="4">
                                <TextBlock Text="{x:Static resources:Strings.Media_LastPlayed}"
                                           Foreground="#7BA3FF"
                                           FontWeight="SemiBold"
                                           FontSize="14" />
                                <TextBlock Text="{Binding SelectedItem.LastPlayed, StringFormat={}{0:yyyy-MM-dd HH:mm}}"
                                           Foreground="White" />
                            </StackPanel>

                            <!-- Total play time -->
                            <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Spacing="4">
                                <TextBlock Text="{x:Static resources:Strings.Media_PlayTime}"
                                           Foreground="#7BA3FF"
                                           FontWeight="SemiBold"
                                           FontSize="14" />
                                <TextBlock Text="{Binding SelectedItem.TotalPlayTime, Converter={StaticResource TimeConverter}}"
                                           Foreground="White" />
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        
            <!-- MEDIA panel with same style, some spacing below the metadata panel -->
            <Panel Grid.Row="1" Margin="40,0,60,60">
                <!-- Outer media frame: semi-transparent, like Default -->
                <Border Background="#CC181A20"
                        CornerRadius="8"
                        Padding="16"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Bottom">
                    <!-- Center video + cover group inside the frame -->
                    <Grid ColumnDefinitions="Auto,Auto"
                          ColumnSpacing="24"
                          HorizontalAlignment="Center">
                        <!-- VIDEO SLOT: solid dark background, matches Default inner panels -->
                        <Border x:Name="VideoSlot"
                                Width="854"
                                Height="480"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                Background="#181A20"
                                CornerRadius="6"
                                ClipToBounds="True">
                            <video:VideoSurfaceControl Surface="{Binding MainVideoSurface}"
                                                       Stretch="Uniform"
                                                       IsVisible="{Binding MainVideoHasContent}" />
                        </Border>

                        <!-- COVER for categories (right, centered vertically) -->
                        <Border Grid.Column="1"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                IsVisible="{Binding IsCategorySelectionActive}">
                            <Image helpers:AsyncImageHelper.Url="{Binding SelectedCategory.PrimaryCoverPath}"
                                   Width="280"
                                   Height="380"
                                   Stretch="Uniform" />
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="30"
                                                  OffsetX="0"
                                                  OffsetY="0"
                                                  Color="Black"
                                                  Opacity="0.7" />
                            </Border.Effect>
                        </Border>

                        <!-- COVER for games (right, centered vertically) -->
                        <Border Grid.Column="1"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                IsVisible="{Binding IsGameListActive}">
                            <Image helpers:AsyncImageHelper.Url="{Binding SelectedItem.PrimaryCoverPath}"
                                   Width="280"
                                   Height="380"
                                   Stretch="Uniform" />
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="30"
                                                  OffsetX="0"
                                                  OffsetY="0"
                                                  Color="Black"
                                                  Opacity="0.7" />
                            </Border.Effect>
                        </Border>
                    </Grid>
                </Border>
            </Panel>
        </Grid>
    </Panel>
</UserControl>