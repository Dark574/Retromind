<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Retromind.ViewModels"
             xmlns:ext="clr-namespace:Retromind.Extensions;assembly=Retromind"
             xmlns:helpers="using:Retromind.Helpers"
             xmlns:resources="using:Retromind.Resources"
             xmlns:video="using:Retromind.Helpers.Video"
             x:DataType="vm:BigModeViewModel"
             Background="#111319"
             
             ext:ThemeProperties.Name="Default"
             ext:ThemeProperties.Author="Retromind"
             ext:ThemeProperties.Version="0.2.0"
             ext:ThemeProperties.PrimaryVideoEnabled="True"
             ext:ThemeProperties.VideoSlotName="VideoSlot"
             ext:ThemeProperties.FadeDurationMs="4000"
             ext:ThemeProperties.MoveDurationMs="1100"
             ext:ThemeProperties.PrimaryVisualElementName="CoverPanel"
             ext:ThemeProperties.PrimaryVisualEnterMode="SlideFromLeft"
             ext:ThemeProperties.PrimaryVisualEnterOffsetX="-420"
             ext:ThemeProperties.PrimaryVisualEnterOffsetY="0"
             ext:ThemeProperties.BackgroundVisualElementName="BackgroundVisual"
             ext:ThemeProperties.BackgroundVisualEnterMode="None">

    <UserControl.Resources>
        <x:Double x:Key="LogoHeight">80</x:Double>

        <!-- Soft slide+fade animation for the main title -->
        <Transitions x:Key="TitleTransitions">
            <DoubleTransition Property="{x:Static Visual.OpacityProperty}"
                              Duration="0:0:0.80" />
            <TransformOperationsTransition Property="{x:Static Visual.RenderTransformProperty}"
                                           Duration="0:0:0.80" />
        </Transitions>

        <!-- Slightly slower slide+fade for the cover overlay -->
        <Transitions x:Key="CoverTransitions">
            <DoubleTransition Property="{x:Static Visual.OpacityProperty}"
                              Duration="0:0:2.00">
                <DoubleTransition.Easing>
                    <CubicEaseOut />
                </DoubleTransition.Easing>
            </DoubleTransition>
            <TransformOperationsTransition Property="{x:Static Visual.RenderTransformProperty}"
                                           Duration="0:0:2.00">
                <TransformOperationsTransition.Easing>
                    <CubicEaseOut />
                </TransformOperationsTransition.Easing>
            </TransformOperationsTransition>
        </Transitions>

        <!-- Opacity helper for video visibility -->
        <helpers:BoolToOpacityConverter x:Key="BoolToOpacity" TrueOpacity="1.0" FalseOpacity="0.0" />

        <!-- Playtime formatting -->
        <helpers:TimeSpanToHumanReadableConverter x:Key="TimeConverter" />
    </UserControl.Resources>
    
    <!-- Background layer + actual content -->
    <Grid>
        <!-- Very transparent wallpaper from the current item -->
        <ext:CrossfadeImage x:Name="BackgroundVisual"
                            Url="{Binding ActiveWallpaperPath}"
                            DecodeWidth="1920"
                            DisableCache="True"
                            Stretch="UniformToFill"
                            Opacity="0.30"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            IsVisible="{Binding ActiveWallpaperPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"
                            IsHitTestVisible="False" />

        <!-- Two-column layout: navigation on the left, video + details on the right -->
        <Grid ColumnDefinitions="0.20*,0.80*"
              Margin="32,24">

            <!-- LEFT COLUMN: category, big title, list -->
            <Border Grid.Column="0"
                    Background="#CC20232A"
                    CornerRadius="8"
                    Padding="28,32,24,28">
                <Grid RowDefinitions="Auto,Auto,*">

                    <!-- Category label -->
                    <TextBlock Grid.Row="0"
                               Text="{Binding CategoryTitle}"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Foreground="#7BA3FF"
                               Margin="0,0,0,12"
                               TextTrimming="CharacterEllipsis" />

                    <!-- Big title (selected game) -->
                    <Border Grid.Row="1"
                            Margin="0,0,0,24">
                        <StackPanel Spacing="6">
                            <Grid Height="{StaticResource LogoHeight}">
                                <!-- Game logo (item logo) -->
                                <ext:CrossfadeImage Url="{Binding SelectedItem.PrimaryLogoPath}"
                                                    DecodeWidth="512"
                                                    DisableCache="True"
                                                    FadeDelayMs="120"
                                                    FadeDurationMs="1000"
                                                    Height="{StaticResource LogoHeight}"
                                                    Stretch="Uniform"
                                                    HorizontalAlignment="Left"
                                                    VerticalAlignment="Center"
                                                    IsVisible="{Binding SelectedItem.ItemLogoPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}">
                                    <ext:CrossfadeImage.RenderTransform>
                                        <TranslateTransform X="-12" />
                                    </ext:CrossfadeImage.RenderTransform>
                                    <ext:CrossfadeImage.Transitions>
                                        <StaticResource ResourceKey="TitleTransitions" />
                                    </ext:CrossfadeImage.Transitions>
                                </ext:CrossfadeImage>

                                <!-- Fallback logo when item has no logo (node fallback) -->
                                <ext:CrossfadeImage Url="{Binding ActiveLogoPath}"
                                                    DecodeWidth="512"
                                                    DisableCache="True"
                                                    FadeDelayMs="120"
                                                    FadeDurationMs="1000"
                                                    Height="{StaticResource LogoHeight}"
                                                    Stretch="Uniform"
                                                    HorizontalAlignment="Left"
                                                    VerticalAlignment="Center"
                                                    IsVisible="{Binding SelectedItem.ItemLogoPath, Converter={x:Static helpers:StringConverters.IsNullOrEmpty}}">
                                    <ext:CrossfadeImage.RenderTransform>
                                        <TranslateTransform X="-12" />
                                    </ext:CrossfadeImage.RenderTransform>
                                    <ext:CrossfadeImage.Transitions>
                                        <StaticResource ResourceKey="TitleTransitions" />
                                    </ext:CrossfadeImage.Transitions>
                                </ext:CrossfadeImage>
                            </Grid>

                            <!-- Fallback: text title when no item logo is available -->
                            <TextBlock Text="{Binding SelectedItem.Title}"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       TextWrapping="Wrap"
                                       MaxLines="2"
                                       TextTrimming="CharacterEllipsis"
                                       IsVisible="{Binding SelectedItem.ItemLogoPath, Converter={x:Static helpers:StringConverters.IsNullOrEmpty}}">
                                <TextBlock.RenderTransform>
                                    <!-- Less negative = moves to the right -->
                                    <TranslateTransform X="-12" />
                                </TextBlock.RenderTransform>
                                <TextBlock.Transitions>
                                    <StaticResource ResourceKey="TitleTransitions" />
                                </TextBlock.Transitions>
                            </TextBlock>
                        </StackPanel>
                    </Border>

                    <!-- Row 2: categories OR games depending on view mode -->

                    <!-- Category list (e.g. systems) -->
                    <ListBox Grid.Row="2"
                             ItemsSource="{Binding CurrentCategories}"
                             SelectedItem="{Binding SelectedCategory}"
                             Background="Transparent"
                             BorderThickness="0"
                             Padding="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             helpers:ListBoxBehaviors.CenterSelectedItem="True"
                             IsVisible="{Binding IsCategorySelectionActive}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}"
                                           FontSize="16"
                                           Margin="0,3"
                                           Foreground="White"
                                           TextTrimming="CharacterEllipsis" />
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Game list -->
                    <ListBox Grid.Row="2"
                             ItemsSource="{Binding Items}"
                             SelectedItem="{Binding SelectedItem}"
                             Background="Transparent"
                             BorderThickness="0"
                             Padding="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             helpers:ListBoxBehaviors.CenterSelectedItem="True"
                             IsVisible="{Binding IsGameListActive}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Title}"
                                           FontSize="16"
                                           Margin="0,3"
                                           Foreground="White"
                                           TextTrimming="CharacterEllipsis" />
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- RIGHT COLUMN: big video on top + details below -->
            <Grid Grid.Column="1"
                  Margin="28,0,0,0">
                <Border Background="#CC181A20"
                        CornerRadius="8"
                        Padding="16"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch">

                    <!-- Single container grid for video (top) and details (bottom) -->
                    <Grid RowDefinitions="2*,*">
                        <!-- VIDEO AREA -->
                        <Grid Grid.Row="0">
                            <Border x:Name="VideoSlot"
                                    Background="#181A20"
                                    CornerRadius="6"
                                    ClipToBounds="True"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Stretch">
                                <Grid>
                                    <!-- Optional fallback text while no video is playing -->
                                    <TextBlock Text="No preview video"
                                               Foreground="#606060"
                                               FontSize="18"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>

                            <!-- Cover overlay -->
                            <Border x:Name="CoverPanel"
                                    Width="220"
                                    Height="330"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Top"
                                    Margin="-70,28,0,0"
                                    CornerRadius="8"
                                    ClipToBounds="True"
                                    Background="#00000000"
                                    IsHitTestVisible="False"
                                    IsVisible="{Binding SelectedItem.PrimaryCoverPath,
                                                        Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}">
                                <Image helpers:AsyncImageHelper.Url="{Binding SelectedItem.PrimaryCoverPath}"
                                       helpers:AsyncImageHelper.DecodeWidth="600"
                                       helpers:AsyncImageHelper.DisableCache="True"
                                       Stretch="Uniform"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                            </Border>
                        </Grid>

                        <!-- DETAILS: always fill the available width of the right column -->
                        <Border Grid.Row="1"
                                Margin="0,14,0,0"
                                Background="#E020232A"
                                CornerRadius="6"
                                Padding="14"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled"
                                          HorizontalAlignment="Stretch"
                                          HorizontalContentAlignment="Stretch">
                                <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                      ColumnDefinitions="*,*"
                                      ColumnSpacing="16"
                                      RowSpacing="10">
                                    <!-- Node / item description -->
                                    <StackPanel Grid.Row="0"
                                                Grid.ColumnSpan="2"
                                                Spacing="6">
                                        <TextBlock Text="{x:Static resources:Strings.Common_Description}"
                                                   Foreground="#7BA3FF"
                                                   FontWeight="SemiBold"
                                                   FontSize="14" />

                                        <!-- Description in category mode -->
                                        <TextBlock Text="{Binding SelectedCategory.Description}"
                                                   Foreground="#DDFFFFFF"
                                                   TextWrapping="Wrap"
                                                   MaxHeight="72"
                                                   TextTrimming="CharacterEllipsis"
                                                   IsVisible="{Binding IsCategorySelectionActive}" />

                                        <!-- Description in game mode -->
                                        <TextBlock Text="{Binding SelectedItem.Description}"
                                                   Foreground="#DDFFFFFF"
                                                   TextWrapping="Wrap"
                                                   MaxHeight="72"
                                                   TextTrimming="CharacterEllipsis"
                                                   IsVisible="{Binding IsGameListActive}" />
                                    </StackPanel>

                                    <!-- Release date -->
                                    <StackPanel Grid.Row="1" Grid.Column="0" Spacing="4">
                                        <TextBlock Text="{x:Static resources:Strings.Common_ReleaseDate}"
                                                   Foreground="#7BA3FF"
                                                   FontWeight="SemiBold"
                                                   FontSize="14" />
                                        <TextBlock Text="{Binding SelectedItem.ReleaseDate, StringFormat={}{0:yyyy-MM-dd}}"
                                                   Foreground="White" />
                                    </StackPanel>

                                    <!-- Developer -->
                                    <StackPanel Grid.Row="1" Grid.Column="1" Spacing="4">
                                        <TextBlock Text="{x:Static resources:Strings.Common_Developer}"
                                                   Foreground="#7BA3FF"
                                                   FontWeight="SemiBold"
                                                   FontSize="14" />
                                        <TextBlock Text="{Binding SelectedDeveloper}"
                                                   Foreground="White"
                                                   TextTrimming="CharacterEllipsis" />
                                    </StackPanel>

                                    <!-- Played count -->
                                    <StackPanel Grid.Row="2" Grid.Column="0" Spacing="4">
                                        <TextBlock Text="{x:Static resources:Strings.Media_PlayCount}"
                                                   Foreground="#7BA3FF"
                                                   FontWeight="SemiBold"
                                                   FontSize="14" />
                                        <TextBlock Text="{Binding SelectedItem.PlayCount}"
                                                   Foreground="White" />
                                    </StackPanel>

                                    <!-- Last played -->
                                    <StackPanel Grid.Row="2" Grid.Column="1" Spacing="4">
                                        <TextBlock Text="{x:Static resources:Strings.Media_LastPlayed}"
                                                   Foreground="#7BA3FF"
                                                   FontWeight="SemiBold"
                                                   FontSize="14" />
                                        <TextBlock Text="{Binding SelectedItem.LastPlayed, StringFormat={}{0:yyyy-MM-dd HH:mm}}"
                                                   Foreground="White" />
                                    </StackPanel>

                                    <!-- Play time -->
                                    <StackPanel Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Spacing="4">
                                        <TextBlock Text="{x:Static resources:Strings.Media_PlayTime}"
                                                   Foreground="#7BA3FF"
                                                   FontWeight="SemiBold"
                                                   FontSize="14" />
                                        <TextBlock Text="{Binding SelectedItem.TotalPlayTime, Converter={StaticResource TimeConverter}}"
                                                   Foreground="White" />
                                    </StackPanel>
                                </Grid>
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
