<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Retromind.ViewModels"
             xmlns:ext="clr-namespace:Retromind.Extensions;assembly=Retromind"
             xmlns:helpers="clr-namespace:Retromind.Helpers"
             xmlns:ac="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls"
             xmlns:video="using:Retromind.Helpers.Video"
             xmlns:media="using:Avalonia.Media"
             x:DataType="vm:BigModeViewModel"
             x:Name="ThemeRoot"
             Background="Black"

             ext:ThemeProperties.Name="Arcade"
             ext:ThemeProperties.Author="PLACEHOLDER_AUTHOR"
             ext:ThemeProperties.Version="0.1.0"
             ext:ThemeProperties.SelectedScale="1.06"
             ext:ThemeProperties.UnselectedOpacity="0.75"
             ext:ThemeProperties.SelectedGlowOpacity="0.40"
             ext:ThemeProperties.AccentColor="#00D1FF"
             ext:ThemeProperties.PrimaryVideoEnabled="True"
             ext:ThemeProperties.VideoSlotName="VideoSlot"
             ext:ThemeProperties.SecondaryBackgroundVideoPath="Videos/bkg_anim.mp4"
             ext:ThemeProperties.CircularWindowSize="11"
             ext:ThemeProperties.AttractModeEnabled="True"
             ext:ThemeProperties.AttractModeIdleSeconds="60"
             ext:ThemeProperties.AttractModeSound="sounds/attract_spin.wav">

    <UserControl.Resources>
        <!-- Converter to load theme-local images (e.g. Images/cabinet.png, Images/pointer.png) -->
        <helpers:ThemeAssetToBitmapConverter x:Key="ThemeAssetConverter" />
        <!-- Converter to load absolute/relative file paths into Bitmaps (used for item/node assets) -->
        <helpers:PathToBitmapConverter x:Key="PathToBitmapConverter" />
        <!-- Opacity helper for pointer visibility -->
        <helpers:BoolToOpacityConverter x:Key="BoolToOpacity" TrueOpacity="1.0" FalseOpacity="0.0" />
        <!-- Logo scale converter: local zoom for the ArcadeLogoList -->
        <helpers:BoolToScaleConverter x:Key="LogoScaleConverter"
                                      NormalScale="1.0"
                                      SelectedScale="1.75" />
    </UserControl.Resources>

    <Grid>
        <!-- Background: Video wallpaper + fallback image + dark tint -->
        <Grid>
            <!-- Fallback: static background image -->
            <Image Source="{Binding $parent[UserControl],
                                    Converter={StaticResource ThemeAssetConverter},
                                    ConverterParameter=Images/background.jpg}"
                   Stretch="UniformToFill"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   IsHitTestVisible="False" />
            
            <!-- Video background (Secondary channel) -->
            <video:VideoSurfaceControl Surface="{Binding SecondaryVideoSurface}"
                                       Stretch="UniformToFill"
                                       IsVisible="{Binding SecondaryVideoHasContent}"/>

            <!-- Dark tint above the image/video to keep text readable -->
            <Rectangle Fill="#AA101015" IsHitTestVisible="False" />
        </Grid>

        <!-- Main layout: cabinet area (left) + game list (right) -->
        <Grid ColumnDefinitions="4*,1.25*" Margin="25,20,40,30">

            <!-- LEFT: Arcade cabinet area -->
            <Grid Grid.Column="0"
                  ColumnDefinitions="Auto"
                  RowDefinitions="*">

                <!-- Scalable Cabinet Area: everything within it scales proportionally -->
                <Viewbox Stretch="Uniform"
                         StretchDirection="Both"
                         HorizontalAlignment="Left"
                         VerticalAlignment="Bottom"
                         Margin="-120,40,0,0">
                    <!-- Design coordinate system: 1400x800 (16:9) -->
                    <Grid Width="1400"
                          Height="800">

                        <!-- Cabinet composition -->
                        <Grid>
                            <!-- Overlay-Layer: Marquee + Screen-Area -->
                            <Grid Margin="0"
                                  RowDefinitions="Auto,Auto"
                                  HorizontalAlignment="Center">

                                <!-- Marquee (at the top of the machine) -->
                                <Border Grid.Row="0"
                                        Width="620"
                                        Height="180"
                                        Margin="-128,0,0,0"
                                        Background="Transparent"
                                        ClipToBounds="True">
                                    <Image Source="{Binding ActiveMarqueePath,
                                                        Converter={StaticResource PathToBitmapConverter}}"
                                           Stretch="UniformToFill"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding ActiveMarqueePath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"/>
                                </Border>

                                <!-- Screen-Block -->
                                <Border Grid.Row="1"
                                        Width="520"
                                        Height="390"
                                        Margin="-145,57,0,0"
                                        Background="Transparent"
                                        ClipToBounds="True">
                                    <Grid>
                                        <!-- Video slot in the screen (primary channel).
                                        BigModeHostView attaches the shared _primaryVideoControl here. -->
                                        <Border x:Name="VideoSlot"
                                                Width="520"
                                                Height="390"
                                                Margin="0,0,0,0"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                CornerRadius="0"
                                                Background="#000000"
                                                BorderBrush="#505050"
                                                BorderThickness="2"
                                                ClipToBounds="True">
                                            <Grid>
                                                <!-- Placeholder text when no video is displayed -->
                                                <TextBlock Text="Preview"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           Foreground="#404040"
                                                           FontSize="20"/>
                                            </Grid>
                                        </Border>

                                        <Image Source="{Binding ActiveBezelPath,
                                                                Converter={StaticResource PathToBitmapConverter}}"
                                               Stretch="UniformToFill"
                                               HorizontalAlignment="Stretch"
                                               VerticalAlignment="Stretch"
                                               IsHitTestVisible="False"
                                               IsVisible="{Binding ActiveBezelPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"/>
                                    </Grid>
                                </Border>
                            </Grid>

                            <!-- Cabinet-PNG -->
                            <Image Source="{Binding $parent[UserControl],
                                                Converter={StaticResource ThemeAssetConverter},
                                                ConverterParameter=Images/cabinet.png}"
                                   Stretch="Uniform"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   IsHitTestVisible="False"/>
                        </Grid>
                    </Grid>
                </Viewbox>
            </Grid>

            <!-- RIGHT: vertical logo rail (inspired by the original video) -->
            <Border Grid.Column="1"
                    Background="#66000000"
                    CornerRadius="0"
                    Padding="20,24"
                    Margin="16,20,0,40"
                    HorizontalAlignment="Stretch"
                    MaxWidth="340">
                <ListBox x:Name="ArcadeLogoList"
                         ext:ThemeProperties.UseHostSelectionEffects="False"
                         ItemsSource="{Binding CircularItems}"
                         SelectedItem="{Binding SelectedItem, Mode=OneWay}"
                         Background="Transparent"
                         BorderThickness="0"
                         VerticalAlignment="Center"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Hidden">
                    <!-- Local styles only for this ListBox -->
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}">
                                            <ContentPresenter Content="{TemplateBinding Content}"
                                                              ContentTemplate="{TemplateBinding ContentTemplate}"
                                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>

                            <!-- Completely transparent container, centered -->
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderBrush" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="HorizontalAlignment" Value="Center"/>
                            <Setter Property="VerticalAlignment" Value="Center"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="VerticalContentAlignment" Value="Center"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                        </Style>
                    </ListBox.Styles>
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Vertical"
                                        HorizontalAlignment="Center"
                                        Spacing="8" />
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>

                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <!-- Outer container -->
                            <Border Margin="0,4"
                                    Padding="0"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                                <!-- Zoom via LayoutTransformControl, dependent on IsSelected -->
                                <ac:LayoutTransformControl Padding="2"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center">
                                    <ac:LayoutTransformControl.LayoutTransform>
                                        <ScaleTransform
                                            ScaleX="{Binding $parent[ListBoxItem].IsSelected,
                                                             Converter={StaticResource LogoScaleConverter}}"
                                            ScaleY="{Binding $parent[ListBoxItem].IsSelected,
                                                             Converter={StaticResource LogoScaleConverter}}"/>
                                    </ac:LayoutTransformControl.LayoutTransform>

                                    <StackPanel Orientation="Vertical"
                                                HorizontalAlignment="Center"
                                                Spacing="2">
                                        <!-- Logo -->
                                        <Image helpers:AsyncImageHelper.Url="{Binding PrimaryLogoPath}"
                                               helpers:AsyncImageHelper.DecodeWidth="256"
                                               Width="150"
                                               Stretch="Uniform"
                                               HorizontalAlignment="Center"
                                               IsVisible="{Binding PrimaryLogoPath, Converter={x:Static helpers:StringConverters.IsNotNullOrEmpty}}"/>

                                        <!-- Fallback: Text title if no logo -->
                                        <TextBlock Text="{Binding Title}"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"
                                                   TextAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxWidth="200"
                                                   IsVisible="{Binding ItemLogoPath, Converter={x:Static helpers:StringConverters.IsNullOrEmpty}}"/>
                                    </StackPanel>
                                </ac:LayoutTransformControl>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Border>
        </Grid>

        <!-- Bottom info bar (year, developer, game counter) -->
        <Border VerticalAlignment="Bottom"
                Margin="40,0,40,20"
                CornerRadius="6"
                Background="#66000000"
                Padding="10,6">
            <Grid ColumnDefinitions="*,*,Auto">

                <!-- Left: Year + Developer -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Spacing="8">
                    <TextBlock FontSize="14"
                               Foreground="#CCFFFFFF"
                               Text="{Binding SelectedYear}"/>
                    <TextBlock FontSize="14"
                               Foreground="#CCFFFFFF"
                               Text="{Binding SelectedDeveloper}"
                               TextTrimming="CharacterEllipsis"
                               Margin="8,0,0,0"/>
                </StackPanel>

                <!-- Right: Game counter -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Spacing="4">
                    <TextBlock FontSize="14"
                               Foreground="#88FFFFFF"
                               Text="Game:"/>
                    <TextBlock FontSize="14"
                               Foreground="#CCFFFFFF"
                               Text="{Binding CurrentGameNumber}"/>
                    <TextBlock FontSize="14"
                               Foreground="#88FFFFFF"
                               Text="/"/>
                    <TextBlock FontSize="14"
                               Foreground="#CCFFFFFF"
                               Text="{Binding TotalGames}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
